<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Idle Universe: The Omnidimensional Conflux</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <style>
      @keyframes pulseGlowGreen {
        0%, 100% { box-shadow: 0 0 15px rgba(52, 211, 153, 0.5), 0 0 3px rgba(52, 211, 153, 0.3) inset; }
        50% { box-shadow: 0 0 22px rgba(52, 211, 153, 0.7), 0 0 6px rgba(52, 211, 153, 0.5) inset; }
      }
      @keyframes pulseGlowBlue {
        0%, 100% { box-shadow: 0 0 15px rgba(96, 165, 250, 0.5), 0 0 3px rgba(96, 165, 250, 0.3) inset; border-color: #559CF5; }
        50% { box-shadow: 0 0 22px rgba(96, 165, 250, 0.7), 0 0 6px rgba(96, 165, 250, 0.5) inset; border-color: #7FBFFF; }
      }
      @keyframes shimmerPurple {
        0%, 100% { box-shadow: 0 0 15px rgba(167, 139, 250, 0.4), 0 0 5px rgba(200, 180, 255, 0.2) inset; opacity: 0.85; }
        50% { box-shadow: 0 0 22px rgba(167, 139, 250, 0.6), 0 0 8px rgba(200, 180, 255, 0.4) inset; opacity: 0.95; }
      }
      @keyframes flickerNeonOrange { /* Renamed to flickerWarmOrange for subtlety */
        0%, 100% { box-shadow: 0 0 10px rgba(251, 146, 60, 0.6), 0 0 18px rgba(253, 186, 116, 0.4), 0 0 3px rgba(254, 215, 170, 0.3) inset; }
        50% { box-shadow: 0 0 15px rgba(251, 146, 60, 0.7), 0 0 22px rgba(253, 186, 116, 0.5), 0 0 5px rgba(254, 215, 170, 0.4) inset; }
      }
      @keyframes subtleWarp {
        0%, 100% { transform: skewX(-0.5deg) skewY(0.25deg); }
        50% { transform: skewX(0.5deg) skewY(-0.25deg); }
      }
      @keyframes gentleBob {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-2px); }
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: #111827; /* bg-gray-900 */
        color: #f3f4f6; /* text-gray-100 */
        overscroll-behavior: none;
      }
      .font-arcade {
        font-family: "Press Start 2P", cursive;
      }
      .domain-card {
        background-color: #1f2937; /* bg-gray-800 */
        border: 1px solid #374151; /* border-gray-700 */
        border-radius: 0.5rem; /* rounded-lg */
        padding: 1rem; /* p-4 */
        margin-bottom: 1rem; /* mb-4 */
        transition: box-shadow 0.3s ease, outline 0.2s ease, border-color 0.3s ease; /* Added border-color transition */
      }
      /* Generic hover for non-specific cards, if any. Specific styles will override. */
      .domain-card:hover {
        /* box-shadow: 0 0 15px rgba(79, 70, 229, 0.5); /* shadow-indigo-500/50 - Removed generic shadow */
      }

      /* Gardener: Organic, Quantum Green */
      .domain-card-gardeners {
        background: linear-gradient(135deg, #1E3A2B, #122A1C); /* Softer dark greens */
        border: 2px solid #2FBC87; /* Slightly less vibrant green */
        border-radius: 10px; /* Standardized rounding */
        animation: pulseGlowGreen 3.5s infinite ease-in-out; /* Slower animation */
      }
      .domain-card-gardeners:hover {
        transform: scale(1.015); /* Less aggressive scale */
        box-shadow: 0 0 25px rgba(52, 211, 153, 0.7), 0 0 10px rgba(100, 255, 200, 0.4) inset; /* Softer hover glow */
      }

      /* Soundwaves: Resonant, Electric Blue */
      .domain-card-soundwaves {
        background: linear-gradient(to right, #1A2F6A, #2D65C0); /* Smoother blue gradient */
        border: 2px dashed #5095E0; /* Softer dashed border */
        border-radius: 10px;
        animation: pulseGlowBlue 3s infinite alternate; /* Slower animation */
      }
      .domain-card-soundwaves:hover {
        transform: translateY(-2px); /* Less aggressive lift */
        box-shadow: 0 3px 22px rgba(96, 165, 250, 0.6), 0 0 8px rgba(180, 210, 250, 0.4) inset; /* Softer glow, less white */
        border-style: solid;
      }

      /* Soup: Cosmic Broth - Deep Purples/Blues */
      .domain-card-soup {
        background: linear-gradient(160deg, #2c0b4d, #1a237e); /* Deep dark purple to deep indigo */
        border: 2px solid #7E57C2; /* Deep rich purple border */
        border-radius: 10px; /* Consistent rounding */
        animation: gentleBob 3.5s infinite ease-in-out; /* Keep gentleBob or change if desired */
      }
      .domain-card-soup h3 { /* Target the title specifically */
        color: #EDE7F6 !important; /* Light lavender/off-white for contrast */
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7); /* Darker shadow for light text */
      }
      .domain-card-soup:hover {
        box-shadow: 0 0 20px rgba(126, 87, 194, 0.7), 0 0 8px rgba(150, 120, 220, 0.4) inset; /* Glow matching new border */
        transform: scale(1.01) rotate(0.5deg); /* Slight hover effect */
      }

      /* Afterlives: Ethereal, Spectral Purple */
      .domain-card-afterlives {
        background-color: #2A123A; /* Slightly less saturated deep purple */
        border: 1px solid #9D7FFA; /* Softer purple border */
        border-radius: 10px;
        box-shadow: 0 0 12px rgba(167, 139, 250, 0.3); /* Softer initial shadow */
        animation: shimmerPurple 4.5s infinite ease-in-out; /* Slower animation */
      }
      .domain-card-afterlives:hover {
        background-color: #33105A; /* Slightly lighter hover background */
        border-color: #B8A5FD;
        box-shadow: 0 0 22px rgba(167, 139, 250, 0.6), 0 0 8px rgba(220, 200, 255, 0.3) inset; /* Softer hover glow */
        transform: perspective(600px) rotateY(1deg); /* Less aggressive transform */
      }

      /* Fractals: Geometric, Vibrant Pink */
      .domain-card-fractals {
        background: repeating-linear-gradient(
          45deg,
          #3D0340, /* Darker, less contrasty magenta */
          #3D0340 12px, /* Wider stripes for smoother look */
          #5A155D 12px,
          #5A155D 24px
        );
        border: 2px solid #E06AB0; /* Slightly desaturated pink */
        border-radius: 10px;
        box-shadow: 0 0 8px rgba(244, 114, 182, 0.6), 0 0 4px rgba(244, 114, 182, 0.4) inset; /* Softer initial shadow */
        animation: subtleWarp 6s infinite linear; /* Slower warp */
      }
      .domain-card-fractals:hover {
        transform: scale(1.015); /* Less aggressive scale */
        box-shadow: 0 0 22px rgba(244, 114, 182, 0.7), 0 0 10px rgba(249, 168, 212, 0.4) inset; /* Softer hover glow, no white */
        background-size: 48px 48px; /* Adjust pattern zoom if needed, or remove */
      }

      /* Snackbar: Temporal, Energetic Orange */
      .domain-card-snackbar {
        background: linear-gradient(45deg, #6A260F, #D04A0A); /* Slightly darker, smoother orange gradient */
        border: 2px outset #E88A30; /* Thinner, slightly less bright outset */
        border-radius: 8px; /* Smoother radius */
        animation: flickerWarmOrange 2s infinite steps(3, end); /* Slower, softer flicker (WarmOrange keyframe) */
      }
      .domain-card-snackbar:hover {
        transform: skewX(-1deg); /* Less aggressive skew */
        box-shadow: 0 0 25px rgba(251, 146, 60, 0.7), 0 0 30px rgba(253, 186, 116, 0.5), 0 0 8px rgba(254, 215, 170, 0.4) inset; /* Softer glow, no white */
      }

      /* Emotions: Psychic, Moody Indigo */
      .domain-card-emotions {
        background: radial-gradient(ellipse at bottom, #2B286F, #433DC0); /* Smoother indigo gradient */
        border: 2px solid #707CF0; /* Softer indigo border */
        border-radius: 10px; /* Consistent rounding */
        animation: gentleBob 4s infinite ease-in-out, pulseGlowBlue 4.5s infinite ease-in-out 0.5s; /* Slower animations */
      }
      .domain-card-emotions:hover {
        transform: scale(1.015) translateY(-1px); /* Less aggressive transform */
        box-shadow: 0 0 22px rgba(129, 140, 248, 0.6), 0 0 10px rgba(165, 180, 252, 0.4) inset; /* Softer hover glow */
        background: radial-gradient(ellipse at bottom, #3A32B0, #5558D8); /* Smoother hover background */
      }

      .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem; /* rounded-md */
        font-weight: 500; /* font-medium */
        transition: background-color 0.2s ease, transform 0.1s ease;
        cursor: pointer;
        border: none;
        min-width: 80px;
      }
      .btn-primary {
        background-color: #4f46e5; /* bg-indigo-600 */
        color: white;
      }
      .btn-primary:hover {
        background-color: #4338ca; /* bg-indigo-700 */
      }
      .btn-primary:active {
        transform: scale(0.98);
      }
      .btn-secondary {
        background-color: #374151; /* bg-gray-700 */
        color: #d1d5db; /* text-gray-300 */
      }
      .btn-secondary:hover {
        background-color: #4b5563; /* bg-gray-600 */
      }
      .btn-secondary:active {
        transform: scale(0.98);
      }
      .btn-disabled {
        background-color: #4b5563 !important; /* Ensure disabled style overrides */
        color: #9ca3af !important;
        cursor: not-allowed !important;
      }
      .resource-display {
        font-size: 0.875rem; /* text-sm */
        color: #9ca3af; /* text-gray-400 */
      }
      .story-log {
        background-color: #1f2937; /* bg-gray-800 */
        border: 1px solid #374151; /* border-gray-700 */
        border-radius: 0.5rem; /* rounded-lg */
        padding: 1rem;
        max-height: 280px; /* Increased height */
        overflow-y: auto;
        font-size: 1rem; /* Increased font size (text-base) */
      }
      .story-log-entry {
        padding: 0.375rem 0; /* Adjusted padding */
        border-bottom: 1px solid #374151; /* border-gray-700 */
      }
      .story-log-entry:last-child {
        border-bottom: none;
      }
      .story-log::-webkit-scrollbar,
      #lore-modal-content::-webkit-scrollbar,
      .modal-content-scroll::-webkit-scrollbar {
        width: 8px;
      }
      .story-log::-webkit-scrollbar-track,
      #lore-modal-content::-webkit-scrollbar-track,
      .modal-content-scroll::-webkit-scrollbar-track {
        background: #1f2937; /* bg-gray-800 */
        border-radius: 0.5rem;
      }
      .story-log::-webkit-scrollbar-thumb,
      #lore-modal-content::-webkit-scrollbar-thumb,
      .modal-content-scroll::-webkit-scrollbar-thumb {
        background: #4b5563; /* bg-gray-600 */
        border-radius: 0.5rem;
      }
      .story-log::-webkit-scrollbar-thumb:hover,
      #lore-modal-content::-webkit-scrollbar-thumb:hover,
      .modal-content-scroll::-webkit-scrollbar-thumb:hover {
        background: #6b7280; /* bg-gray-500 */
      }
      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        width: max-content;
        max-width: 250px;
        background-color: #111827; /* bg-gray-900 */
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 100; /* Ensure tooltip is above overlays */
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.75rem; /* text-xs */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      }
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
      .target-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 40;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5rem;
        pointer-events: none; /* Allow clicks to pass through to elements below */
      }
      .domain-card.targetable {
        /* Style for when a domain is a valid target */
        outline: 2px solid #fbbf24; /* amber-400 - Persistent outline */
        cursor: crosshair;
        /* opacity-75 is applied via JS, which is fine */
      }
      .domain-card.targetable:hover {
        /* Optional: slightly different hover style if needed */
        outline-width: 3px; /* Example: thicker outline on hover */
      }
      .stat-bar {
        height: 10px;
        background-color: #374151; /* bg-gray-700 */
        border-radius: 0.25rem; /* rounded-sm */
        overflow: hidden;
      }
      .stat-bar-fill {
        height: 100%;
        background-color: #ef4444; /* red-500 */
        transition: width 0.3s ease;
        border-radius: 0.25rem; /* rounded-sm */
      }
      /* Modal Styles (Generic) */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        z-index: 50; /* Default modal z-index */
      }
      .modal-content-wrapper {
        background-color: #1f2937; /* bg-gray-800 */
        padding: 1.5rem; /* p-6 */
        border-radius: 0.5rem; /* rounded-lg */
        max-width: 42rem; /* max-w-2xl */
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
        border: 1px solid #374151; /* border-gray-700 */
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem; /* mb-4 */
      }
      .modal-title {
        font-size: 1.5rem; /* text-2xl */
        font-family: "Press Start 2P", cursive;
        color: #818cf8; /* text-indigo-400 */
      }
      .modal-close-button {
        color: #9ca3af; /* text-gray-400 */
        font-size: 2.25rem; /* text-3xl */
        line-height: 1;
        font-weight: bold;
        background: none;
        border: none;
        cursor: pointer;
      }
      .modal-close-button:hover {
        color: white;
      }
      .modal-body {
        color: #d1d5db; /* text-gray-300 */
        font-size: 0.95rem;
      }
      .modal-body ul {
        list-style-type: disc;
        padding-left: 1.5rem;
        margin-top: 0.5rem;
        margin-bottom: 1rem;
      }
      .modal-body li {
        margin-bottom: 0.5rem;
      }
      .modal-body strong {
        color: #a5b4fc; /* indigo-300 */
      }
      /* Coach Mark Styles */
      .coach-mark-overlay {
        z-index: 1000; /* Must be on top of everything */
      }
      .coach-mark-highlight {
        outline: 3px solid #fcd34d; /* amber-300 */
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.65); /* Dim background */
        border-radius: 0.375rem; /* rounded-md, adjust as needed */
        position: relative; /* Needed for z-index to work with the shadow */
        z-index: 1001; /* Above the dimming overlay part */
        transition: outline 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }
      .coach-mark-highlight-pulsate {
        animation: coachPulse 1.5s infinite;
      }
      @keyframes coachPulse {
        0% {
          outline-color: #fcd34d;
        } /* amber-300 */
        50% {
          outline-color: #fbbf24;
        } /* amber-400 */
        100% {
          outline-color: #fcd34d;
        }
      }
      .coach-mark-message-box {
        position: fixed;
        background-color: #111827; /* bg-gray-900 */
        color: #e5e7eb; /* text-gray-200 */
        padding: 1rem;
        border-radius: 0.5rem; /* rounded-lg */
        border: 2px solid #818cf8; /* indigo-400 */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        z-index: 1002; /* Above highlight */
        max-width: 300px;
        text-align: center;
      }
      /* Trophy Gallery Styles */
      .trophy-item {
        position: relative;
        width: 80px; /* Adjusted for better visibility */
        height: 80px;
        background-color: #1f2937; /* bg-gray-800 */
        border: 1px solid #374151; /* border-gray-700 */
        border-radius: 0.375rem; /* rounded-md */
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: default;
        overflow: hidden;
      }
      .trophy-item img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
        border-radius: 0.375rem; /* rounded-md */
      }
      .trophy-item.locked img {
        filter: grayscale(100%) opacity(0.3);
      }
      .trophy-item.locked::after {
        content: "?";
        position: absolute;
        font-size: 2.5rem; /* Larger '?' */
        font-family: "Press Start 2P", cursive; /* Consistent font */
        color: #4b5563; /* text-gray-600 */
        text-shadow: 1px 1px #111827;
      }
      .trophy-item .trophy-tooltiptext {
        visibility: hidden;
        width: max-content;
        max-width: 220px; /* Slightly wider for stories */
        background-color: #111827; /* bg-gray-900 */
        color: #fff;
        text-align: left; /* Better for multi-line stories */
        border-radius: 6px;
        padding: 10px; /* More padding */
        position: absolute;
        z-index: 100;
        bottom: 105%; /* Adjust position */
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8rem; /* Slightly larger text */
        line-height: 1.4;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.6);
        pointer-events: none; /* Allow hover over image beneath */
      }
      .trophy-item .trophy-tooltiptext strong {
        color: #a5b4fc; /* indigo-300 */
        display: block;
        margin-bottom: 4px;
      }
      .trophy-item:hover .trophy-tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      /* Trophy Unlock Modal Styles */
      .trophy-unlock-modal-overlay {
        /* Uses .modal-overlay for base, but we can add specifics */
        z-index: 1050; /* Higher than other modals if needed */
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
      }
      .trophy-unlock-modal-overlay.visible {
        opacity: 1;
      }
      .trophy-unlock-modal-content {
        background-color: #111827; /* bg-gray-900, darker for drama */
        padding: 2rem; /* p-8 */
        border-radius: 0.75rem; /* rounded-xl */
        max-width: 36rem; /* max-w-lg */
        width: 90%;
        text-align: center;
        box-shadow: 0 0 30px rgba(129, 140, 248, 0.5); /* shadow-indigo-400/50, more dramatic */
        border: 2px solid #818cf8; /* border-indigo-400 */
        position: relative; /* For close button positioning */
        transform: scale(0.95);
        transition: transform 0.3s ease-in-out;
      }
      .trophy-unlock-modal-overlay.visible .trophy-unlock-modal-content {
        transform: scale(1);
      }
      .trophy-unlock-title {
        font-family: "Press Start 2P", cursive;
        color: #fcd34d; /* amber-300 */
        font-size: 1.75rem; /* text-2xl or 3xl */
        margin-bottom: 1.5rem;
        text-shadow: 2px 2px #000;
      }
      .trophy-unlock-modal-content img {
        max-width: 200px; /* Control image size */
        max-height: 200px;
        object-fit: contain;
        border-radius: 0.5rem; /* rounded-lg */
        margin: 0 auto 1.5rem auto; /* Center image and add space below */
        border: 3px solid #a5b4fc; /* indigo-300 */
        background-color: #1f2937; /* bg-gray-800 for contrast if image has transparency */
      }
      .trophy-unlock-modal-content h3 {
        /* Trophy Name */
        font-family: "Press Start 2P", cursive;
        color: #a5b4fc; /* indigo-300 */
        font-size: 1.25rem; /* text-xl */
        margin-bottom: 0.75rem;
      }
      .trophy-unlock-modal-content p {
        /* Trophy Story */
        color: #e5e7eb; /* text-gray-200 */
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 2rem;
      }
      /* Close button for trophy unlock modal can reuse .modal-close-button if positioned correctly */
      .trophy-unlock-modal-content .modal-close-button {
        position: absolute;
        top: 0.5rem;
        right: 0.75rem;
      }
      .btn-audio {
        background-color: #52525b; /* zinc-600 */
        color: white;
        padding: 0.5rem 0.75rem; /* Smaller padding */
      }
      .btn-audio:hover {
        background-color: #71717a; /* zinc-500 */
      }
      .btn-gallery {
        background-color: #10B981; /* emerald-500 */
        color: white;
        padding: 0.5rem 0.75rem;
      }
      .btn-gallery:hover {
        background-color: #059669; /* emerald-600 */
      }
    </style>
  </head>
  <body class="min-h-screen p-2 sm:p-4 md:p-6">
    <div class="container mx-auto max-w-7xl">
      <header
        class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center"
      >
        <div class="text-center md:text-left mb-4 md:mb-0">
          <h1
            class="text-3xl sm:text-4xl md:text-5xl font-arcade text-indigo-400"
          >
            Idle Universe
          </h1>
          <p class="text-lg sm:text-xl font-arcade text-indigo-200">
            The Omnidimensional Conflux
          </p>
          <p id="quick-start-tagline" class="text-sm text-amber-300 mt-1"></p>
        </div>
        <div class="flex flex-wrap justify-center md:justify-end space-x-2">
          <button
            id="save-game-button"
            class="btn btn-secondary text-sm font-arcade mb-2 md:mb-0"
          >
            Save
          </button>
          <button
            id="load-game-button"
            class="btn btn-secondary text-sm font-arcade mb-2 md:mb-0"
          >
            Load
          </button>
          <button
            id="help-button"
            class="btn btn-secondary text-sm font-arcade mb-2 md:mb-0"
          >
            Help (?)
          </button>
          <button
            id="mute-button"
            class="btn btn-audio text-sm font-arcade mb-2 md:mb-0"
          >
            Mute üîä
          </button>
          <button
            id="gallery-button"
            class="btn btn-gallery text-sm font-arcade mb-2 md:mb-0"
          >
            Gallery üñºÔ∏è
          </button>
        </div>
      </header>

      <!-- Global Stats Container -->
      <div class="bg-gray-800 p-4 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-2 text-amber-400">
          Global Stats
        </h2>
        <p>
          Entropy Tokens:
          <span
            id="entropy-tokens-display"
            class="font-bold text-xl text-purple-400"
            >0</span
          >
        </p>
        <p class="mt-1">
          Reality Strain:
          <span
            id="reality-strain-display"
            class="font-bold text-xl text-red-400"
            >0</span
          >
          / 100
        </p>
        <div class="stat-bar mt-2">
          <div id="reality-strain-bar" class="stat-bar-fill"></div>
        </div>
        <div class="tooltip"> <!-- Added tooltip wrapper -->
          <button
            id="prestige-button"
            class="btn btn-primary mt-4 w-full font-arcade text-lg"
            disabled
          >
            Conflux Collapse!
          </button>
          <span id="prestige-tooltip" class="tooltiptext" style="width: 300px; text-align: left; line-height: 1.5;">
            <!-- Content will be set by JS -->
          </span>
        </div>
      </div>

      <!-- Story Log Container -->
      <div id="story-log-container" class="bg-gray-800 p-4 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-2 text-sky-400">
          Conflux Echoes (Story Log)
        </h2>
        <div id="story-log" class="story-log">
          <p class="text-gray-500">The universe is quiet... for now.</p>
        </div>
      </div>

      <div
        id="domains-container"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
      ></div>

      <!-- Inline gallery removed, will be in a modal -->
    </div>

    <div id="target-overlay" class="target-overlay hidden">
      <p class="font-arcade text-2xl">SELECT TARGET DOMAIN</p>
    </div>

    <div id="lore-modal" class="modal-overlay hidden">
      <div class="modal-content-wrapper">
        <div class="modal-header">
          <h2 id="lore-modal-title" class="modal-title">Domain Lore</h2>
          <button id="close-lore-modal" class="modal-close-button">
            &times;
          </button>
        </div>
        <div
          id="lore-modal-content"
          class="modal-body modal-content-scroll"
        ></div>
      </div>
    </div>

    <div id="how-to-play-modal" class="modal-overlay hidden">
      <div class="modal-content-wrapper">
        <div class="modal-header">
          <h2 class="modal-title">Welcome, Shaper!</h2>
          <button id="close-how-to-play-modal" class="modal-close-button">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <p class="mb-3 text-lg">Here's the core of the Conflux:</p>
          <ul>
            <li>
              <strong>Gather Resources:</strong> Click on a Domain card (like
              Quantum Gardeners) to get its main resource.
            </li>
            <li>
              <strong>Automate:</strong> Spend those resources on Generators
              within a Domain to earn passively.
            </li>
            <li>
              <strong>Interact:</strong> Use Abilities to boost yourself or
              affect other Domains. Watch their cooldowns!
            </li>
            <li>
              <strong>Manage Strain:</strong> Actions increase Reality Strain
              (top bar).
            </li>
            <li>
              <strong>Prestige:</strong> When Reality Strain is full, use
              'Conflux Collapse!' to earn Entropy Tokens for powerful permanent
              upgrades.
            </li>
          </ul>
          <p class="mt-4 text-center">The Conflux awaits your touch!</p>
          <button
            id="got-it-how-to-play-modal"
            class="btn btn-primary w-full mt-6 font-arcade"
          >
            Let's Go!
          </button>
        </div>
      </div>
    </div>

    <div id="help-modal" class="modal-overlay hidden">
      <div class="modal-content-wrapper">
        <div class="modal-header">
          <h2 class="modal-title">Conflux Guide</h2>
          <button id="close-help-modal" class="modal-close-button">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <h3 class="text-xl font-semibold text-amber-300 mb-2">
            Quick Start:
          </h3>
          <ul>
            <li>Click a Domain card to earn its primary resource.</li>
            <li>Spend resources on Generators for passive income.</li>
            <li>Use abilities to buff yourself or affect other Domains.</li>
            <li>
              Actions increase <strong>Reality Strain</strong>. When it's full, the "Conflux Collapse!" button activates.
            </li>
          </ul>
          <h3 class="text-xl font-semibold text-amber-300 mt-4 mb-2">
            Conflux Collapse (Prestige):
          </h3>
          <ul>
            <li>
              Clicking "Conflux Collapse!" resets your current game progress: resources, generator levels, and domain unlocks (except the first).
            </li>
            <li>
              In return, you earn <strong style="color: #A78BFA;">Entropy Tokens</strong>. The more progress you've made (especially total generator levels), the more tokens you'll get.
            </li>
            <li>
              <strong>Each Entropy Token permanently grants:</strong>
              <ul>
                <li style="margin-left: 1rem;">- <strong style="color: #6EE7B7;">+1%</strong> to Global Production Rate for all generators.</li>
                <li style="margin-left: 1rem;">- <strong style="color: #6EE7B7;">+0.5%</strong> to Global Click Power for all domains.</li>
              </ul>
            </li>
            <li>
              Prestiging is key to long-term growth, allowing you to reach new heights much faster in subsequent cycles!
            </li>
          </ul>
          <p class="mt-4 text-sm text-gray-400">
            More detailed guides and domain specifics can be found by exploring
            and using the "View Lore" buttons on each domain card.
          </p>
        </div>
      </div>
    </div>

    <div id="gallery-modal" class="modal-overlay hidden">
      <div class="modal-content-wrapper" style="max-width: 56rem;"> <!-- Wider for gallery -->
        <div class="modal-header">
          <h2 class="modal-title text-green-400">Conflux Gallery</h2>
          <button id="close-gallery-modal" class="modal-close-button">
            &times;
          </button>
        </div>
        <div class="modal-body modal-content-scroll">
          <div
            id="gallery-modal-trophies-container"
            class="grid grid-cols-4 xs:grid-cols-5 sm:grid-cols-6 md:grid-cols-7 lg:grid-cols-8 gap-2 sm:gap-3 justify-center"
          >
            <!-- Trophies will be injected here -->
          </div>
        </div>
      </div>
    </div>
    
    <div id="coach-mark-overlay-container"></div>

    <div
      id="trophy-unlock-modal"
      class="modal-overlay hidden trophy-unlock-modal-overlay"
    >
      <div class="trophy-unlock-modal-content">
        <button id="close-trophy-unlock-modal" class="modal-close-button">
          &times;
        </button>
        <h2 id="trophy-unlock-title" class="trophy-unlock-title">
          Gallery Image Unlocked!
        </h2>
        <img id="trophy-unlock-image" src="" alt="Unlocked Trophy Image" />
        <h3 id="trophy-unlock-name">Trophy Name</h3>
        <p id="trophy-unlock-story">Trophy story will appear here.</p>
        <button
          id="confirm-trophy-unlock-modal"
          class="btn btn-primary font-arcade"
        >
          Awesome!
        </button>
      </div>
    </div>

    <script>
      const DOMAIN_UNLOCK_ORDER = ["gardeners", "soundwaves", "emotions", "soup", "snackbar", "fractals", "afterlives"];

      // --- AUDIO MANAGER ---
      const AudioManager = (() => {
        let audioContext = null;
        let isMuted = false;
        let currentSoundSource = null;
        const AUDIO_MUTED_KEY = "idleUniverseAudioMuted_v1";
        let muteButtonElement = null;

        function _updateMuteButtonUI() {
          if (muteButtonElement) {
            muteButtonElement.textContent = isMuted ? "Unmute üîà" : "Mute üîä";
          }
        }

        function init() { // Call this on first user gesture
          if (audioContext && audioContext.state === 'running') return true;
          
          if (!audioContext) {
            try {
              audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
              console.error("Web Audio API not supported.", e);
              Bus.emit("feedback:message", { message: "Audio disabled: Web Audio API not supported.", type: "warning" });
              isMuted = true; // Force mute if context fails
              _updateMuteButtonUI();
              return false;
            }
          }

          if (audioContext.state === 'suspended') {
            audioContext.resume()
              .then(() => {
                console.log("AudioContext resumed.");
                Bus.emit("feedback:message", { message: "Audio enabled.", type: "info" });
              })
              .catch(e => {
                console.error("Error resuming AudioContext:", e);
                Bus.emit("feedback:message", { message: "Could not enable audio.", type: "warning" });
                isMuted = true; // Force mute if resume fails
                _updateMuteButtonUI();
              });
          }
          return true;
        }

        function playSound(filePath) {
          if (isMuted || !audioContext || audioContext.state !== 'running') {
            if (!audioContext || audioContext.state !== 'running') {
              // console.warn("AudioContext not ready. Click something to enable audio.");
            }
            return;
          }

          if (currentSoundSource) {
            try {
              currentSoundSource.stop();
            } catch (e) { /* ignore */ }
            currentSoundSource.disconnect();
            currentSoundSource = null;
          }

          fetch(filePath)
            .then(response => {
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${filePath}`);
              return response.arrayBuffer();
            })
            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
            .then(audioBuffer => {
              const source = audioContext.createBufferSource();
              source.buffer = audioBuffer;
              source.connect(audioContext.destination);
              source.start(0);
              currentSoundSource = source;
              source.onended = () => {
                if (currentSoundSource === source) {
                  currentSoundSource = null;
                }
              };
            })
            .catch(e => console.error(`Error playing sound ${filePath}:`, e));
        }

        function toggleMute() {
          if (!audioContext || audioContext.state === 'suspended') {
            init(); 
          }
          isMuted = !isMuted;
          localStorage.setItem(AUDIO_MUTED_KEY, isMuted.toString());
          _updateMuteButtonUI();
          if (isMuted && currentSoundSource) {
            try {
              currentSoundSource.stop();
            } catch (e) { /* ignore */ }
            currentSoundSource.disconnect();
            currentSoundSource = null;
          }
          Bus.emit("feedback:message", { message: isMuted ? "Audio Muted üîà" : "Audio Unmuted üîä", type: "info" });
        }

        function loadMuteState() {
          const storedMuteState = localStorage.getItem(AUDIO_MUTED_KEY);
          isMuted = storedMuteState === "true";
          muteButtonElement = document.getElementById("mute-button");
          if (muteButtonElement) {
            muteButtonElement.addEventListener('click', toggleMute);
          }
          _updateMuteButtonUI();
        }
        
        return {
          init,
          playSound,
          loadMuteState
        };
      })();

      // --- AUDIO TRIGGER MAP ---
      const DOMAIN_SPECIFIC_AUDIO_TRIGGERS = {
        "gardeners": {
          "intro": "out_audio/gardeners_01_intro.mp3", // Handled by DOMAIN_INTRO_AUDIO
          "first_resource_probabilityPetal": "out_audio/gardeners_02_first_petal.mp3",
          "first_generator_timelineBloomer": "out_audio/gardeners_03_bloomer_purchase.mp3", // Also tied to lore 3
          "generator_milestone_level_10_total": "out_audio/gardeners_04_ten_bloomers.mp3", // Also tied to lore 4
          "ability_cast_collapseCertainty": "out_audio/gardeners_05_first_ability.mp3",
          "resource_milestone_100_probabilityPetal": "out_audio/gardeners_06_hundred_petals.mp3",
          "lore_level_5": "out_audio/gardeners_07_lore_level5.mp3",
          "lore_level_8": "out_audio/gardeners_08_many_worlds_orchard.mp3", // Example: tie to lore 8
          "first_trophy": "out_audio/gardeners_09_first_trophy.mp3",
          "gained_entropy_tokens": "out_audio/gardeners_10_entropy_tokens.mp3",
          "half_strain": "out_audio/gardeners_11_half_strain.mp3",
          "collapse_ready": "out_audio/gardeners_12_conflux_collapse_ready.mp3",
          "post_prestige": "out_audio/gardeners_13_post_prestige.mp3",
          "generator_milestone_level_50_total": "out_audio/gardeners_14_level_fifty.mp3",
          "lore_level_10": "out_audio/gardeners_15_final_ascension.mp3"
        },
        "soundwaves": {
          "intro": "out_audio/soundwaves_01_intro.mp3", // Handled by DOMAIN_INTRO_AUDIO
          "first_resource_echoRoyalty": "out_audio/soundwaves_02_first_echo.mp3",
          "first_generator_cosmicArtist": "out_audio/soundwaves_03_artist_hired.mp3",
          "lore_level_X_bass_drop": "out_audio/soundwaves_04_bass_drop.mp3", // Assign to a lore level or specific event
          "ability_cast_dissonanceBurst": "out_audio/soundwaves_05_dissonance_burst_cast.mp3",
          "resource_milestone_1000_echoRoyalty": "out_audio/soundwaves_06_echo_milestone_1k.mp3",
          "lore_level_7_amp_cathedral": "out_audio/soundwaves_07_amp_cathedral_complete.mp3", // Example: lore 7
          "lore_level_Y_silence_harvested": "out_audio/soundwaves_08_silence_harvested.mp3", // Assign
          "first_trophy": "out_audio/soundwaves_09_trophy_unlocked.mp3",
          "lore_level_6_loop_song": "out_audio/soundwaves_10_loop_song.mp3", // Example: lore 6
          "half_strain": "out_audio/soundwaves_11_half_strain_warning.mp3",
          "collapse_ready": "out_audio/soundwaves_12_collapse_ready.mp3",
          "post_prestige": "out_audio/soundwaves_13_post_prestige_remix.mp3",
          "generator_milestone_level_50_total": "out_audio/soundwaves_14_level_fifty_artists.mp3",
          "lore_level_10": "out_audio/soundwaves_15_grand_unified_metronome.mp3"
        },
        "soup": {
          "intro": "out_audio/soup_01_intro.mp3", // Handled by DOMAIN_INTRO_AUDIO
          "first_resource_flavorQuark": "out_audio/soup_02_first_quark.mp3",
          "first_generator_primordialBroth": "out_audio/soup_03_broth_started.mp3",
          "ability_cast_bigSlurp": "out_audio/soup_04_big_slurp_cast.mp3",
          "resource_milestone_1000_flavorQuark": "out_audio/soup_05_quark_milestone_1k.mp3",
          "lore_level_X_alphabet": "out_audio/soup_06_alphabet_particles.mp3", // Assign
          "lore_level_Y_kimchi": "out_audio/soup_07_kimchi_fermented.mp3", // Assign
          "lore_level_Z_foam": "out_audio/soup_08_flavor_foam.mp3", // Assign
          "first_trophy": "out_audio/soup_09_trophy_unlocked.mp3",
          "half_strain": "out_audio/soup_10_half_strain_warning.mp3",
          "collapse_ready": "out_audio/soup_11_collapse_ready.mp3",
          "post_prestige": "out_audio/soup_12_post_prestige_flavor.mp3",
          "generator_milestone_level_50_total": "out_audio/soup_13_level_fifty_broth.mp3",
          "ability_milestone_slurp_chain": "out_audio/soup_14_slurp_chain.mp3", // e.g. 3 slurps this prestige
          "lore_level_10": "out_audio/soup_15_omniversal_recipe.mp3"
        },
        "afterlives": {
          "intro": "out_audio/afterlives_01_intro.mp3", // Handled by DOMAIN_INTRO_AUDIO
          "first_resource_existentialStamp": "out_audio/afterlives_02_first_stamp.mp3",
          "first_generator_soulClerk": "out_audio/afterlives_03_clerk_hired.mp3",
          "ability_cast_auditRival": "out_audio/afterlives_04_audit_cast.mp3",
          "resource_milestone_1000_existentialStamp": "out_audio/afterlives_05_stamp_milestone_1k.mp3",
          "lore_level_X_in_tray": "out_audio/afterlives_06_infinite_in_tray.mp3", // Assign
          "lore_level_Y_union": "out_audio/afterlives_07_union_formed.mp3", // Assign
          "first_trophy": "out_audio/afterlives_08_trophy_unlocked.mp3",
          "half_strain": "out_audio/afterlives_09_half_strain_warning.mp3",
          "collapse_ready": "out_audio/afterlives_10_collapse_ready.mp3",
          "post_prestige": "out_audio/afterlives_11_post_prestige_clearance.mp3",
          "generator_milestone_level_50_total": "out_audio/afterlives_12_level_fifty_clerks.mp3",
          "lore_level_Z_debt_gremlins": "out_audio/afterlives_13_debt_gremlins.mp3", // Assign
          "lore_level_W_compliance": "out_audio/afterlives_14_metaphysical_compliance.mp3", // Assign
          "lore_level_10": "out_audio/afterlives_15_backlog_resolved.mp3"
        },
        "fractals": {
          "intro": "out_audio/fractals_01_intro.mp3", // Handled by DOMAIN_INTRO_AUDIO
          "first_resource_symmetryShard": "out_audio/fractals_02_first_shard.mp3",
          "first_generator_fractalPet": "out_audio/fractals_03_pet_forged.mp3",
          "ability_cast_recursiveSwarm": "out_audio/fractals_04_swarm_cast.mp3",
          "resource_milestone_1000_symmetryShard": "out_audio/fractals_05_shard_milestone_1k.mp3",
          "lore_level_X_inversion": "out_audio/fractals_06_factory_inversion.mp3", // Assign
          "first_trophy": "out_audio/fractals_07_trophy_unlocked.mp3",
          "lore_level_Y_vault": "out_audio/fractals_08_negative_dimension_vault.mp3", // Assign
          "lore_level_Z_shield": "out_audio/fractals_09_antifractal_shield.mp3", // Assign
          "half_strain": "out_audio/fractals_10_half_strain_warning.mp3",
          "collapse_ready": "out_audio/fractals_11_collapse_ready.mp3",
          "post_prestige": "out_audio/fractals_12_post_prestige_reset.mp3",
          "generator_milestone_level_50_total": "out_audio/fractals_13_level_fifty_pets.mp3",
          "lore_level_W_mirror_cache": "out_audio/fractals_14_mirror_cache_found.mp3", // Assign
          "lore_level_10": "out_audio/fractals_15_micro_civilization.mp3"
        },
        "snackbar": {
          "intro": "out_audio/snackbar_01_intro.mp3", // Handled by DOMAIN_INTRO_AUDIO
          "first_resource_chronoTip": "out_audio/snackbar_02_first_tip.mp3",
          "first_generator_eraFoodTruck": "out_audio/snackbar_03_truck_bought.mp3",
          "ability_cast_paradoxSurge": "out_audio/snackbar_04_paradox_surge_cast.mp3",
          "resource_milestone_1000_chronoTip": "out_audio/snackbar_05_tip_milestone_1k.mp3",
          "lore_level_X_fryer": "out_audio/snackbar_06_temporal_fryer.mp3", // Assign
          "lore_level_Y_inspection": "out_audio/snackbar_07_health_inspection_passed.mp3", // Assign
          "first_trophy": "out_audio/snackbar_08_trophy_unlocked.mp3",
          "half_strain": "out_audio/snackbar_09_half_strain_warning.mp3",
          "collapse_ready": "out_audio/snackbar_10_collapse_ready.mp3",
          "post_prestige": "out_audio/snackbar_11_post_prestige_grand_reopening.mp3",
          "generator_milestone_level_50_total": "out_audio/snackbar_12_level_fifty_trucks.mp3",
          "lore_level_Z_ramen": "out_audio/snackbar_13_epoch_ramen.mp3", // Assign
          "lore_level_W_insurance": "out_audio/snackbar_14_insurance_claim.mp3", // Assign
          "lore_level_10": "out_audio/snackbar_15_omnipresent_fleet.mp3"
        },
        "emotions": {
          "intro": "out_audio/emotions_01_intro.mp3", // Handled by DOMAIN_INTRO_AUDIO
          "first_resource_vibeOre": "out_audio/emotions_02_first_vibe.mp3",
          "first_generator_empathyReactor": "out_audio/emotions_03_reactor_built.mp3",
          "ability_cast_serenityField": "out_audio/emotions_04_serenity_field_cast.mp3",
          "resource_milestone_1000_vibeOre": "out_audio/emotions_05_vibe_milestone_1k.mp3",
          "lore_level_X_regret_gas": "out_audio/emotions_06_regret_gas_detected.mp3", // Assign
          "lore_level_Y_plateau": "out_audio/emotions_07_subconscious_plateau.mp3", // Assign
          "first_trophy": "out_audio/emotions_08_trophy_unlocked.mp3",
          "half_strain": "out_audio/emotions_09_half_strain_warning.mp3",
          "collapse_ready": "out_audio/emotions_10_collapse_ready.mp3",
          "post_prestige": "out_audio/emotions_11_post_prestige_new_mood.mp3",
          "generator_milestone_level_50_total": "out_audio/emotions_12_level_fifty_reactors.mp3",
          "lore_level_Z_nostalgia": "out_audio/emotions_13_nostalgia_vein.mp3", // Assign
          "lore_level_W_courage": "out_audio/emotions_14_courage_plumes.mp3", // Assign
          "lore_level_10": "out_audio/emotions_15_psycho_crystal_bloom.mp3"
        }
      };

      function playDominantAudio(eventType, specificData = null) {
        let audioFileToPlay = null;
        for (const domainId of [...DOMAIN_UNLOCK_ORDER].reverse()) {
          if (Game.domains[domainId]?.unlocked) {
            const domainAudioMap = DOMAIN_SPECIFIC_AUDIO_TRIGGERS[domainId];
            if (domainAudioMap && domainAudioMap[eventType]) {
              audioFileToPlay = domainAudioMap[eventType];
              break;
            }
          }
        }
        if (audioFileToPlay) {
          // Check if this specific audio event has a flag and if it has been played
          const audioFlag = `played_audio_${eventType}_${specificData || 'global'}`;
          if (Game.storyFlags[audioFlag]) return; // Already played this specific one

          AudioManager.playSound(audioFileToPlay);
          Game.storyFlags[audioFlag] = true; // Mark as played
        }
      }

      // --- 1. EVENT BUS ---
      const Bus = (() => {
        const listeners = new Map();
        return {
          on: (t, fn) =>
            (listeners.get(t) ?? listeners.set(t, new Set())).get(t).add(fn),
          off: (t, fn) => listeners.get(t)?.delete(fn),
          emit: (t, payload) =>
            listeners.get(t)?.forEach((fn) => {
              try {
                fn(payload);
              } catch (e) {
                console.error(`Error in Bus listener for ${t}:`, e, payload);
              }
            }),
        };
      })();

      // --- 2. CORE STATE CONTAINER ---
      const Game = {
        t: 0,
        lastUpdate: Date.now(),
        domains: {},
        resources: {},
        buffs: [],
        entropyTokens: 0,
        realityStrain: 0,
        maxRealityStrain: 100,
        prestigeCount: 0,
        activeTargeting: null,
        tutorialFlags: {}, // For in-session tutorial step tracking
        storyFlags: {
          // For multi-level lore and specific story event triggers
          // --- Flags for "cast ability X once EVER" ---
          gardeners_castCollapseCertaintyOnce: false,
          soundwaves_castDissonanceBurstOnce: false,
          soup_castBigSlurpOnce: false,
          afterlives_castAuditRivalOnce: false,
          fractals_castRecursiveSwarmOnce: false,
          snackbar_castParadoxSurgeOnce: false,
          emotions_castSerenityFieldOnce: false,
          // --- Flags for "achieve X with Y ability EVER" ---
          rivalsTargetedByAbilities: new Set(), // Stores domain IDs of rivals targeted by any ability
          afterlives_auditedRivals: new Set(), // Stores domain IDs of rivals audited by Bureaucratic Afterlives
          // --- Flags that reset on prestige ---
          soup_slurpsThisPrestige: 0,
          snackbar_surgesThisPrestige: 0,
          storyEventStates: {}, // To store { eventId: { fired: boolean } }
          // Flags for one-time audio events, e.g., played_gardeners_first_resource_audio: true
          // These will be dynamically checked/set by story events or direct calls.
          // Global audio cycle flags
          playedHalfStrainAudioThisCycle: false,
          playedCollapseReadyAudioThisCycle: false,
          playedEntropyTokensAudioThisPrestige: false,
          playedPostPrestigeAudioThisCycle: false,
        },
        unlockedTrophies: new Set(), // For tracking unlocked gallery images

        addResource(id, amt = 0) {
          this.resources[id] = (this.resources[id] ?? 0) + amt;
          if (this.resources[id] < 0) this.resources[id] = 0;
          Bus.emit("resource:update", {
            resourceId: id,
            amount: this.resources[id],
          });
        },
        getResource(id) {
          return this.resources[id] ?? 0;
        },
        increaseRealityStrain(amount) {
          this.realityStrain = Math.min(
            this.realityStrain + amount,
            this.maxRealityStrain
          );
          Bus.emit("realityStrain:update", {
            current: this.realityStrain,
            max: this.maxRealityStrain,
          });
        },
      };

      // --- 3. FACTORY HELPERS ---
      function defineDomain(cfg) {
        Game.domains[cfg.id] = {
          ...cfg,
          level: 0,
          unlocked: cfg.id === DOMAIN_UNLOCK_ORDER[0], // Unlock the first domain by default
          generators: (cfg.generators || []).map((g) => ({
            ...g,
            level: 0,
            currentCost: { ...g.baseCost },
          })),
          abilities: (cfg.abilities || []).map((a) => ({ ...a, nextUse: 0 })),
          isTargetable: false,
          allLoreTexts: cfg.allLoreTexts || [], // Array of 10 lore strings
          unlockedLoreLevel: 0, // Highest lore level unlocked for this domain
        };
        // Ensure current `lore` property from cfg is not directly used if `allLoreTexts` is primary
        // delete Game.domains[cfg.id].lore; // Or handle its transition carefully

        Game.addResource(cfg.clickResource.id, 0);
        (cfg.generators || []).forEach((gen) =>
          Object.keys(gen.baseCost).forEach((resId) =>
            Game.addResource(resId, 0)
          )
        );
        (cfg.abilities || []).forEach((ab) => {
          if (ab.cost)
            Object.keys(ab.cost).forEach((resId) => Game.addResource(resId, 0));
        });
      }

      // --- 4. CORE GAME ACTIONS (clickDomain, buyGenerator, castAbility, tick) ---
      // These functions remain largely the same as in the previous version,
      // with minor adjustments for tutorial integration or clarity if needed.
      // For brevity, I'll only show changes or key parts.
      function clickDomain(domainId) {
        AudioManager.init(); // Ensure audio context is active on user interaction
        const domain = Game.domains[domainId];
        if (!domain) return;
        let clickMultiplier = 1;
        Game.buffs.forEach((buff) => {
          if (
            buff.affects === "click" &&
            (!buff.domainId || buff.domainId === domainId)
          ) {
            clickMultiplier *= buff.multiplier || 1;
          }
        });
        const gain =
          domain.clickResource.baseAmount *
          clickMultiplier *
          (1 + Game.entropyTokens * 0.005);
        Game.addResource(domain.clickResource.id, gain);
        Game.increaseRealityStrain(0.01 * (Game.prestigeCount + 1));

        // Tutorial Hook
        if (
          domainId === "gardeners" &&
          !Game.tutorialFlags.clickedFirstDomain
        ) {
          TutorialManager.advanceStepIfCurrent("clickFirstDomain");
        }
      }

      function buyGenerator(domainId, generatorId) {
        const domain = Game.domains[domainId];
        const gen = domain.generators.find((g) => g.id === generatorId);
        if (!domain || !gen) return;
        const finalCost = { ...gen.currentCost };
        if (gen.costMultiplier && gen.costMultiplier > 1) {
          for (const resId in finalCost) {
            finalCost[resId] = Math.floor(
              finalCost[resId] * gen.costMultiplier
            );
          }
        }

        if (payCost(finalCost)) {
          gen.level++;
          Object.keys(gen.baseCost).forEach((resId) => {
            gen.currentCost[resId] = Math.floor(
              gen.baseCost[resId] * Math.pow(gen.costScaling, gen.level)
            );
          });
          Game.increaseRealityStrain(
            0.1 * gen.level * (Game.prestigeCount + 1)
          );
          Bus.emit("generator:bought", {
            domainId,
            generatorId,
            newLevel: gen.level,
            newCost: gen.currentCost,
          });

          // Tutorial Hook
          if (
            domainId === "gardeners" &&
            generatorId === "timelineBloomer" &&
            !Game.tutorialFlags.boughtFirstGenerator
          ) {
            TutorialManager.advanceStepIfCurrent("buyFirstGenerator");
          }
        } else {
          Bus.emit("feedback:message", {
            message: "Not enough resources!",
            type: "error",
          });
        }
      }

      function castAbility(casterDomainId, abilityId, targetDomainId = null) {
        // ... (existing castAbility logic)
        // No direct tutorial hooks here for now, but could be added
        const casterDomain = Game.domains[casterDomainId];
        const ability = casterDomain.abilities.find((a) => a.id === abilityId);

        if (!casterDomain || !ability) return;
        if (Game.t < ability.nextUse) {
          Bus.emit("feedback:message", {
            message: "Ability on cooldown!",
            type: "warning",
          });
          return;
        }
        if (ability.requiresTarget && !targetDomainId) {
          // Check if we are already targeting with this exact ability
          if (
            Game.activeTargeting &&
            Game.activeTargeting.casterId === casterDomainId &&
            Game.activeTargeting.abilityId === abilityId
          ) {
            // Clicked the same ability button again, so cancel targeting
            Game.activeTargeting = null;
            Bus.emit("ability:targeting_ended");
            return; // Exit castAbility
          }

          // Otherwise, start new targeting
          Game.activeTargeting = {
            casterId: casterDomainId,
            abilityId: abilityId,
            ability: ability,
          };
          Bus.emit("ability:targeting_started", { casterDomainId, abilityId });
          return;
        }

        if (payCost(ability.cost)) {
          const targetDomain = targetDomainId
            ? Game.domains[targetDomainId]
            : null;
          try {
            ability.effect(casterDomain, targetDomain);
          } catch (e) {
            console.error("Error executing ability effect:", ability.id, e);
            Bus.emit("feedback:message", {
              message: `Error with ability ${ability.name}.`,
              type: "error",
            });
            return;
          }
          ability.nextUse = Game.t + ability.cooldownMs;
          Game.increaseRealityStrain(
            (ability.strainFactor || 1) * (Game.prestigeCount + 1)
          );
          Bus.emit("ability:cast", {
            casterDomainId,
            abilityId,
            targetDomainId,
            nextUse: ability.nextUse,
          });

          // Play audio for first cast of specific abilities
          const abilityAudioKey = `ability_cast_${abilityId}`;
          const audioFlagKey = `played_audio_cast_${casterDomainId}_${abilityId}`;
          if (DOMAIN_SPECIFIC_AUDIO_TRIGGERS[casterDomainId]?.[abilityAudioKey] && !Game.storyFlags[audioFlagKey]) {
            AudioManager.playSound(DOMAIN_SPECIFIC_AUDIO_TRIGGERS[casterDomainId][abilityAudioKey]);
            Game.storyFlags[audioFlagKey] = true;
          }

          // --- Story Flag Updates on Ability Cast ---
          if (targetDomainId && targetDomainId !== casterDomainId) {
            Game.storyFlags.rivalsTargetedByAbilities.add(targetDomainId);
          }
          if (
            casterDomainId === "gardeners" &&
            abilityId === "collapseCertainty"
          )
            Game.storyFlags.gardeners_castCollapseCertaintyOnce = true;
          if (
            casterDomainId === "soundwaves" &&
            abilityId === "dissonanceBurst"
          )
            Game.storyFlags.soundwaves_castDissonanceBurstOnce = true;
          if (casterDomainId === "soup" && abilityId === "bigSlurp") {
            Game.storyFlags.soup_castBigSlurpOnce = true;
            Game.storyFlags.soup_slurpsThisPrestige =
              (Game.storyFlags.soup_slurpsThisPrestige || 0) + 1;
          }
          if (casterDomainId === "afterlives" && abilityId === "auditRival") {
            Game.storyFlags.afterlives_castAuditRivalOnce = true;
            if (targetDomainId)
              Game.storyFlags.afterlives_auditedRivals.add(targetDomainId);
          }
          if (casterDomainId === "fractals" && abilityId === "recursiveSwarm")
            Game.storyFlags.fractals_castRecursiveSwarmOnce = true;
          if (casterDomainId === "snackbar" && abilityId === "paradoxSurge") {
            Game.storyFlags.snackbar_castParadoxSurgeOnce = true;
            Game.storyFlags.snackbar_surgesThisPrestige =
              (Game.storyFlags.snackbar_surgesThisPrestige || 0) + 1;
          }
          if (casterDomainId === "emotions" && abilityId === "serenityField")
            Game.storyFlags.emotions_castSerenityFieldOnce = true;
          // --- End Story Flag Updates ---

          if (Game.activeTargeting) Bus.emit("ability:targeting_ended");
          Game.activeTargeting = null;
          // Tutorial Hook for first ability cast
          if (!Game.tutorialFlags.castFirstAbility) {
            TutorialManager.advanceStepIfCurrent("castFirstAbility");
          }
        } else {
          Bus.emit("feedback:message", {
            message: "Not enough resources for ability!",
            type: "error",
          });
          if (Game.activeTargeting) Bus.emit("ability:targeting_ended");
          Game.activeTargeting = null;
        }
      }

      function tick(dtMs) {
        Game.t += dtMs;
        // ... (existing passive generation logic) ...
        Object.values(Game.domains).forEach((d) => {
          let domainProductionMultiplier = 1 * getGlobalProductionMultiplier();
          Game.buffs.forEach((buff) => {
            if (buff.affects === "production" && buff.domainId === d.id) {
              domainProductionMultiplier *= buff.multiplier || 1;
            }
          });
          d.generators.forEach((g) => {
            if (g.level > 0) {
              let baseGenProd =
                typeof g.baseProd === "number"
                  ? g.baseProd
                  : g.baseProd[d.clickResource.id] || 0;
              const gain =
                baseGenProd *
                g.level *
                Math.pow(g.prodScaling, g.level - 1) *
                domainProductionMultiplier *
                (dtMs / 1000);
              Game.addResource(d.clickResource.id, gain);
            }
          });
        });
        // ... (existing buff expiry logic) ...
        const activeBuffs = [];
        Game.buffs.forEach((buff) => {
          if (Game.t < buff.until) {
            activeBuffs.push(buff);
            if (buff.onTick) buff.onTick(Game, buff.domainId);
          } else {
            if (buff.onEnd) buff.onEnd(Game, buff.domainId);
            Bus.emit("buff:expired", {
              buffId: buff.id,
              domainId: buff.domainId,
            });
          }
        });
        Game.buffs = activeBuffs;

        Bus.emit("tick", dtMs);
        checkAndUnlockNextDomain(); // Check for new domain unlocks
        checkAndUnlockTrophies(); // Check for new trophy unlocks
        
        // Global Audio Triggers in Tick
        if (Game.realityStrain >= Game.maxRealityStrain * 0.5) {
          if (!Game.storyFlags.playedHalfStrainAudioThisCycle) {
            playDominantAudio("half_strain"); // playDominantAudio handles its own one-time flag for this specific event type
            Game.storyFlags.playedHalfStrainAudioThisCycle = true;
          }
        } else {
          Game.storyFlags.playedHalfStrainAudioThisCycle = false; // Reset when condition no longer met
        }

        if (Game.realityStrain >= Game.maxRealityStrain) {
          if (!Game.storyFlags.playedCollapseReadyAudioThisCycle) {
            playDominantAudio("collapse_ready");
            Game.storyFlags.playedCollapseReadyAudioThisCycle = true;
          }
        } else {
          Game.storyFlags.playedCollapseReadyAudioThisCycle = false; // Reset if strain drops somehow or on prestige
        }

        TutorialManager.checkState(); // Check tutorial state every tick
      }

      // --- 5. UTILS (getGlobalProductionMultiplier, payCost, addBuff) ---
      // Largely unchanged
      function getGlobalProductionMultiplier() {
        let mult = 1;
        Game.buffs.forEach((b) => {
          if (b.affects === "global_production" && !b.domainId)
            mult *= b.multiplier || 1;
        });
        mult *= 1 + Game.entropyTokens * 0.01;
        return mult;
      }
      function payCost(costObj) {
        if (!costObj) return true;
        for (const resId in costObj) {
          if (Game.getResource(resId) < costObj[resId]) return false;
        }
        for (const resId in costObj) {
          Game.addResource(resId, -costObj[resId]);
        }
        return true;
      }
      function addBuff(buffConfig) {
        const newBuff = {
          ...buffConfig,
          startTime: Game.t,
          until: Game.t + buffConfig.durationMs,
        };
        if (newBuff.replacesExisting) {
          Game.buffs = Game.buffs.filter(
            (b) =>
              !(
                b.id.startsWith(newBuff.id.split("_")[0]) &&
                b.domainId === newBuff.domainId
              )
          );
        }
        Game.buffs.push(newBuff);
        if (newBuff.onApply) newBuff.onApply(Game, newBuff.domainId);
        Bus.emit("buff:added", newBuff);
      }

      // --- 6. STORY ENGINE (addStoryEvent, checkStoryEvents) ---
      // Largely unchanged, but new tutorial hints will be added via addStoryEvent
      const storyEvents = [];
      let storyLogInitialized = false;
      function addStoryEvent(
        id,
        triggerFn,
        message,
        oneTime = true,
        onFireAction = null,
        audioFile = null
      ) {
        storyEvents.push({
          id,
          trigger: triggerFn,
          message,
          action: onFireAction,
          fired: Game.storyFlags.storyEventStates[id]?.fired || false, // Initialize from persistent state
          oneTime,
          audioFile,
        });
      }
      function checkStoryEvents() {
        storyEvents.forEach((ev) => {
          // ev.fired is initialized by addStoryEvent using Game.storyFlags.storyEventStates
          if ((!ev.fired || !ev.oneTime) && ev.trigger(Game)) {
            if (ev.oneTime) {
              ev.fired = true;
              Game.storyFlags.storyEventStates[ev.id] = { fired: true }; // Persist change
            }
            addMessageToStoryLog(`üìú ${ev.message}`, "story-log-entry text-teal-300");
            if (ev.action) ev.action(Game);
            if (ev.audioFile) {
              AudioManager.playSound(ev.audioFile);
            }
            Bus.emit("story:fired", { eventId: ev.id, message: ev.message, audioFile: ev.audioFile });
          }
        });
      }

      // --- PRESTIGE ---
      // Largely unchanged
      function attemptPrestige() {
        Game.storyFlags.playedEntropyTokensAudioThisPrestige = false; // Reset at start of attempt
        if (Game.realityStrain >= Game.maxRealityStrain) {
          const tokensEarned = Math.floor(
            1 +
              Game.prestigeCount * 0.5 +
              Object.values(Game.domains).reduce(
                (sum, d) => sum + d.generators.reduce((s, g) => s + g.level, 0),
                0
              ) /
                20
          );
          Game.entropyTokens += tokensEarned;
          Game.prestigeCount++;
          Game.resources = {};
          Object.values(Game.domains).forEach((d) => {
            d.level = 0;
            d.generators.forEach((g) => {
              g.level = 0;
              g.currentCost = { ...g.baseCost };
              delete g.costMultiplier;
            });
            d.abilities.forEach((a) => (a.nextUse = 0));
            d.unlocked = (d.id === DOMAIN_UNLOCK_ORDER[0]); // Reset unlock status
            Game.addResource(d.clickResource.id, 0);
            // d.unlockedLoreLevel remains, as lore unlocks are persistent across prestiges.
          });
          Game.buffs = [];
          Game.realityStrain = 0;
          Game.tutorialFlags = {}; // Reset in-session tutorial flags

          // Reset cycle-specific story flags
          Game.storyFlags.soup_slurpsThisPrestige = 0;
          Game.storyFlags.snackbar_surgesThisPrestige = 0;
          
          // Reset global audio cycle flags
          Game.storyFlags.playedHalfStrainAudioThisCycle = false;
          Game.storyFlags.playedCollapseReadyAudioThisCycle = false;
          // Game.storyFlags.playedEntropyTokensAudioThisPrestige is handled per prestige
          // Game.storyFlags.playedPostPrestigeAudioThisCycle is handled per prestige

          // Play post-prestige audio
          if (!Game.storyFlags.playedPostPrestigeAudioThisCycle) { // Should be this prestige, not cycle
             playDominantAudio("post_prestige");
             Game.storyFlags.playedPostPrestigeAudioThisCycle = true; // Set for this cycle
          }
          // Play entropy tokens audio (if new tokens were earned)
          if (tokensEarned > 0 && !Game.storyFlags.playedEntropyTokensAudioThisPrestige) {
            playDominantAudio("gained_entropy_tokens");
            Game.storyFlags.playedEntropyTokensAudioThisPrestige = true;
          }


          // Persistent story flags (like castOnce, rivalsTargetedByAbilities, auditedRivals) are NOT reset here.

          storyEvents.forEach((ev) => {
            // For lore events, they are typically oneTime. If any non-lore story events are repeatable per prestige:
            if (!ev.oneTime && !ev.id.includes("_lore_lvl")) {
              ev.fired = false;
              // Also update persistent state:
              if (Game.storyFlags.storyEventStates[ev.id]) {
                Game.storyFlags.storyEventStates[ev.id].fired = false;
              }
            }
          });
          storyLogInitialized = false;
          const storyLog = document.getElementById("story-log");
          if (storyLog)
            storyLog.innerHTML =
              '<p class="text-gray-500">A new cycle begins...</p>';
          Bus.emit("game:prestiged", {
            tokensEarned,
            totalTokens: Game.entropyTokens,
          });
          Bus.emit("feedback:message", {
            message: `üåå CONFLUX COLLAPSED! üåå<br>You earned <strong style="color: #FCD34D;">${tokensEarned}</strong> Entropy Token(s)!<br>Total: <strong style="color: #A78BFA;">${Game.entropyTokens}</strong> Tokens.<br>Global Production: <strong style="color: #6EE7B7;">+${Game.entropyTokens}%</strong>, Click Power: <strong style="color: #6EE7B7;">+${(Game.entropyTokens * 0.5).toFixed(1)}%</strong>.<br>A new cycle begins with enhanced potential!`,
            type: "success",
            fontClass: "font-arcade text-lg", // Adjusted size for more text
          });
          renderAllDomains();
          updateGlobalStatsUI();
          TutorialManager.resetForNewSession(); // Reset tutorial for next prestige if not fully completed globally
          renderAllTrophies(); // Update gallery after prestige (reflects persistent unlocks)
          TutorialManager.checkState(); // Check if tutorial needs to restart
          
          // Reset for next prestige cycle
          Game.storyFlags.playedPostPrestigeAudioThisCycle = false; 
          // playedEntropyTokensAudioThisPrestige should persist for the whole prestige, then reset on next
        } else {
          Bus.emit("feedback:message", {
            message: "Reality is not strained enough to collapse!",
            type: "warning",
          });
        }
      }

      // --- SAVE/LOAD SYSTEM ---
      const SAVE_KEY = "idleUniverseSave_v1";

      function saveGame() {
        const saveState = {
          t: Game.t,
          domains: {},
          resources: { ...Game.resources },
          entropyTokens: Game.entropyTokens,
          realityStrain: Game.realityStrain,
          maxRealityStrain: Game.maxRealityStrain,
          prestigeCount: Game.prestigeCount,
          storyFlags: {
            ...Game.storyFlags,
            rivalsTargetedByAbilities: Array.from(
              Game.storyFlags.rivalsTargetedByAbilities
            ),
            afterlives_auditedRivals: Array.from(
              Game.storyFlags.afterlives_auditedRivals
            ),
          },
          unlockedTrophies: Array.from(Game.unlockedTrophies),
          tutorialFlags: { ...Game.tutorialFlags }, // Save persistent tutorial flags
          // Do not save: lastUpdate, buffs, activeTargeting (these are transient or re-initialized)
        };

        Object.keys(Game.domains).forEach((domainId) => {
          const domain = Game.domains[domainId];
          saveState.domains[domainId] = {
            level: domain.level,
            generators: domain.generators.map((g) => ({
              id: g.id,
              level: g.level,
              currentCost: { ...g.currentCost },
              costMultiplier: g.costMultiplier, // Save this if it exists
            })),
            abilities: domain.abilities.map((a) => ({
              id: a.id,
              nextUse: a.nextUse,
            })),
            unlockedLoreLevel: domain.unlockedLoreLevel,
            unlocked: domain.unlocked, // Save unlock status
          };
        });

        try {
          localStorage.setItem(SAVE_KEY, JSON.stringify(saveState));
          Bus.emit("feedback:message", {
            message: "Game Saved!",
            type: "success",
          });
        } catch (e) {
          console.error("Error saving game:", e);
          Bus.emit("feedback:message", {
            message: "Failed to save game. Storage might be full.",
            type: "error",
          });
        }
      }

      function loadGame() {
        const savedDataString = localStorage.getItem(SAVE_KEY);
        if (!savedDataString) {
          Bus.emit("feedback:message", {
            message: "No save game found.",
            type: "info",
          });
          return false;
        }

        try {
          const loadedState = JSON.parse(savedDataString);

          Game.t = loadedState.t || 0;
          Game.resources = loadedState.resources || {};
          Game.entropyTokens = loadedState.entropyTokens || 0;
          Game.realityStrain = loadedState.realityStrain || 0;
          Game.maxRealityStrain = loadedState.maxRealityStrain || 100;
          Game.prestigeCount = loadedState.prestigeCount || 0;

          // Story Flags
          if (loadedState.storyFlags) {
            Game.storyFlags = {
              ...Game.storyFlags, // Keep defaults for any new flags
              ...loadedState.storyFlags,
              rivalsTargetedByAbilities: new Set(
                loadedState.storyFlags.rivalsTargetedByAbilities || []
              ),
              afterlives_auditedRivals: new Set(
                loadedState.storyFlags.afterlives_auditedRivals || []
              ),
            };
          }

          Game.unlockedTrophies = new Set(loadedState.unlockedTrophies || []);
          Game.tutorialFlags = loadedState.tutorialFlags || {};

          // Domains: Iterate through defined domains and apply saved state
          Object.keys(Game.domains).forEach((domainId) => {
            const currentDomain = Game.domains[domainId];
            const savedDomain = loadedState.domains?.[domainId];

            if (savedDomain) {
              currentDomain.level = savedDomain.level || 0;
              currentDomain.unlockedLoreLevel = savedDomain.unlockedLoreLevel || 0;
              currentDomain.unlocked = savedDomain.unlocked ?? (currentDomain.id === DOMAIN_UNLOCK_ORDER[0]);


              currentDomain.generators.forEach((currentGen) => {
                const savedGen = savedDomain.generators?.find(
                  (sg) => sg.id === currentGen.id
                );
                if (savedGen) {
                  currentGen.level = savedGen.level || 0;
                  currentGen.currentCost = savedGen.currentCost
                    ? { ...currentGen.baseCost, ...savedGen.currentCost }
                    : { ...currentGen.baseCost };
                  // Recalculate cost for safety if not perfectly saved, or trust saved cost
                  if (
                    currentGen.level > 0 &&
                    (!savedGen.currentCost ||
                      Object.keys(savedGen.currentCost).length === 0)
                  ) {
                    Object.keys(currentGen.baseCost).forEach((resId) => {
                      currentGen.currentCost[resId] = Math.floor(
                        currentGen.baseCost[resId] *
                          Math.pow(currentGen.costScaling, currentGen.level)
                      );
                    });
                  }
                  if (savedGen.costMultiplier) {
                    currentGen.costMultiplier = savedGen.costMultiplier;
                  } else {
                    delete currentGen.costMultiplier;
                  }
                }
              });

              currentDomain.abilities.forEach((currentAb) => {
                const savedAb = savedDomain.abilities?.find(
                  (sa) => sa.id === currentAb.id
                );
                if (savedAb) {
                  currentAb.nextUse = savedAb.nextUse || 0;
                }
              });
            }
          });

          // Reset transient states
          Game.lastUpdate = Date.now();
          Game.buffs = [];
          Game.activeTargeting = null;
          storyLogInitialized = false; // Force story log re-init
          const storyLog = document.getElementById("story-log");
          if (storyLog)
            storyLog.innerHTML =
              '<p class="text-gray-500">Game loaded. Echoes resume...</p>';

          renderAllDomains();
          renderAllTrophies();
          updateGlobalStatsUI();
          checkStoryEvents(); // Re-evaluate story events based on loaded state
          TutorialManager.checkState(); // Re-evaluate tutorial state

          Bus.emit("feedback:message", {
            message: "Game Loaded Successfully!",
            type: "success",
          });
          return true;
        } catch (e) {
          console.error("Error loading game:", e);
          Bus.emit("feedback:message", {
            message: "Failed to load game. Save data might be corrupted.",
            type: "error",
          });
          localStorage.removeItem(SAVE_KEY); // Clear corrupted save
          return false;
        }
      }

      // --- TROPHY GALLERY SYSTEM ---
      const TROPHIES = [
        // Quantum Gardeners
        {
          id: "gardeners01_trophy",
          name: "Quantum Bloom",
          imagePath: "out/gardeners01.png",
          story:
            "Beneath twin quantum moons, the first Probability Petals unfurl, each a nascent universe of 'what if'. This is where your journey as a Shaper begins, in the heart of the Grove's vibrant, chaotic potential.",
          unlockCondition: (game) =>
            game.getResource("probabilityPetal") >= 200 &&
            game.domains.gardeners?.unlockedLoreLevel >= 1,
        },
        {
          id: "gardeners02_trophy",
          name: "Nanobot Pruners",
          imagePath: "out/gardeners02.png",
          story:
            "Evolved from lab assistants, these microscopic caretakers now sculpt reality itself, tending to wavefunction bonsai. Their delicate work ensures the Grove doesn't collapse under its own infinite possibilities.",
          unlockCondition: (game) =>
            game.domains.gardeners?.generators.find(
              (g) => g.id === "timelineBloomer"
            )?.level >= 3 && game.domains.gardeners?.unlockedLoreLevel >= 2,
        },
        {
          id: "gardeners03_trophy",
          name: "Hourglass Pollinators",
          imagePath: "out/gardeners03.png",
          story:
            "Timeline Bloomers, resembling cosmic hourglasses, drift through the Grove. They sow seeds of uncertainty, ensuring that no single future becomes too dominant, a crucial act for maintaining the Conflux's balance.",
          unlockCondition: (game) =>
            game.storyFlags.gardeners_castCollapseCertaintyOnce &&
            game.domains.gardeners?.unlockedLoreLevel >= 3,
        },
        {
          id: "gardeners04_trophy",
          name: "Many-Worlds Orchard",
          imagePath: "out/gardeners04.png",
          story:
            "Here, each fruit is a self-contained universe, a tangible outcome of the Grove's endless branching. To taste one is to experience a sliver of infinity, a concept central to the Gardeners' philosophy.",
          unlockCondition: (game) =>
            game.domains.gardeners?.unlockedLoreLevel >= 4 &&
            (game.domains.gardeners?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 10,
        },
        {
          id: "gardeners05_trophy",
          name: "Wave-Particle Glasshouse",
          imagePath: "out/gardeners05.png",
          story:
            "This structure shimmers, its panes flickering between wave and particle states. Inside, flora of pure potential are nurtured, a testament to the Gardeners' mastery over the fundamental nature of reality.",
          unlockCondition: (game) =>
            game.domains.gardeners?.unlockedLoreLevel >= 5 &&
            game.getResource("probabilityPetal") >= 10000,
        },
        {
          id: "gardeners06_trophy",
          name: "Dice-Flower Lattice",
          imagePath: "out/gardeners06.png",
          story:
            "Probability vines entwine a crystalline lattice where dice-shaped flowers bloom. Each roll, a new law of physics, a new chance for the Grove, a gamble with the Conflux itself.",
          unlockCondition: (game) =>
            game.domains.gardeners?.unlockedLoreLevel >= 6 &&
            Game.entropyTokens >= 3,
        },
        {
          id: "gardeners07_trophy",
          name: "Entangled Mantle Weavers",
          imagePath: "out/gardeners07.png",
          story:
            "The Gardener Elders, beings of immense understanding, weave cosmic tapestries from entangled photon threads. These 'Probability Mantles' shield nascent realities, a vital defense in the chaotic Conflux.",
          unlockCondition: (game) =>
            game.domains.gardeners?.unlockedLoreLevel >= 8 &&
            (game.domains.gardeners?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 25,
        },
        // Sentient Soundwaves
        {
          id: "soundwaves01_trophy",
          name: "Aurora Amphitheater",
          imagePath: "out/soundwaves01.png",
          story:
            "In a crystal hall suspended over the void, sentient basswaves sculpt auroras from silent starlight. This is the birthplace of Echoes, where the first vibrations of the Conflux gained awareness.",
          unlockCondition: (game) =>
            game.getResource("echoRoyalty") >= 200 &&
            game.domains.soundwaves?.unlockedLoreLevel >= 1,
        },
        {
          id: "soundwaves02_trophy",
          name: "Melodic Surfers",
          imagePath: "out/soundwaves02.png",
          story:
            "Golden treble clefs, the Soundwaves' artists, ride currents of pure resonance. They compose reality's soundtrack, their melodies shaping the very fabric of their domain and influencing others.",
          unlockCondition: (game) =>
            game.domains.soundwaves?.generators.find(
              (g) => g.id === "cosmicArtist"
            )?.level >= 3 && game.domains.soundwaves?.unlockedLoreLevel >= 2,
        },
        {
          id: "soundwaves03_trophy",
          name: "Gravity Beat Drop",
          imagePath: "out/soundwaves03.png",
          story:
            "The legendary Bass-Drop Billow unleashes a beat so profound it warps spacetime itself. A risky maneuver, it demonstrates the raw power the Soundwaves can wield within the Conflux.",
          unlockCondition: (game) =>
            game.storyFlags.soundwaves_castDissonanceBurstOnce &&
            game.domains.soundwaves?.unlockedLoreLevel >= 3,
        },
        {
          id: "soundwaves04_trophy",
          name: "Harmonic Cathedrals",
          imagePath: "out/soundwaves04.png",
          story:
            "Amp-Cathedral spires vibrate at dusk, their stained glass windows singing to the stars. These structures are more than buildings; they are instruments amplifying the Soundwaves' influence.",
          unlockCondition: (game) =>
            game.domains.soundwaves?.unlockedLoreLevel >= 4 &&
            (game.domains.soundwaves?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 10,
        },
        {
          id: "soundwaves05_trophy",
          name: "Reality Foam Silence",
          imagePath: "out/soundwaves05.png",
          story:
            "A bubble of noise-cancelling foam, a sanctuary where lyric monks find perfect, protective silence. Even in a domain of sound, the power of its absence is understood and harnessed.",
          unlockCondition: (game) =>
            game.domains.soundwaves?.unlockedLoreLevel >= 5 &&
            game.getResource("echoRoyalty") >= 10000,
        },
        {
          id: "soundwaves06_trophy",
          name: "Temporal Chorus Loop",
          imagePath: "out/soundwaves06.png",
          story:
            "The Chorus Collective's song echoes through time, a melody caught in an eternal loop. This mastery over temporal acoustics hints at the deeper connections between Conflux domains.",
          unlockCondition: (game) =>
            game.domains.soundwaves?.unlockedLoreLevel >= 6 &&
            Game.prestigeCount >= 1,
        },
        {
          id: "soundwaves07_trophy",
          name: "Grand Unified Metronome",
          imagePath: "out/soundwaves07.png",
          story:
            "A cosmic metronome with glowing strings connects dimensions, its rhythm the heartbeat of all existence within the Conflux. The Soundwaves seek to tune everything to their Grand Unified Melody.",
          unlockCondition: (game) =>
            game.domains.soundwaves?.unlockedLoreLevel >= 8 &&
            (game.domains.soundwaves?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 25,
        },
        // Cosmic Soup Ladle
        {
          id: "soup01_trophy",
          name: "Primordial Stir",
          imagePath: "out/soup01.png",
          story:
            "A divine ladle stirs the nascent universe, seasoning reality with sizzling Flavor Quarks. This is the act of creation itself, the moment flavor was introduced to the cosmic equation.",
          unlockCondition: (game) =>
            game.getResource("flavorQuark") >= 200 &&
            game.domains.soup?.unlockedLoreLevel >= 1,
        },
        {
          id: "soup02_trophy",
          name: "Alphabet Particle Soup",
          imagePath: "out/soup02.png",
          story:
            "Pasta-like letters drift in the cosmic broth, spelling out the universe's quantum recipes. The Ladle's domain is one of constant, delicious experimentation with the building blocks of reality.",
          unlockCondition: (game) =>
            game.domains.soup?.generators.find(
              (g) => g.id === "primordialBroth"
            )?.level >= 3 && game.domains.soup?.unlockedLoreLevel >= 2,
        },
        {
          id: "soup03_trophy",
          name: "Reverse-Time Noodles",
          imagePath: "out/soup03.png",
          story:
            "Noodles that defy entropy, spiraling counterclockwise in a bowl at the edge of time. A culinary paradox, they represent the Ladle's ability to bend even fundamental laws for the perfect dish.",
          unlockCondition: (game) =>
            game.storyFlags.soup_castBigSlurpOnce &&
            game.domains.soup?.unlockedLoreLevel >= 3,
        },
        {
          id: "soup04_trophy",
          name: "Bouillon Star Nebulae",
          imagePath: "out/soup04.png",
          story:
            "Stars of pure flavor melt into nebulae, each a unique taste in the cosmic palate. The Ladle harvests these for its grandest recipes, influencing the very essence of nearby realities.",
          unlockCondition: (game) =>
            game.domains.soup?.unlockedLoreLevel >= 4 &&
            (game.domains.soup?.generators.reduce((s, g) => s + g.level, 0) ||
              0) >= 10,
        },
        {
          id: "soup05_trophy",
          name: "Dark Matter Kimchi",
          imagePath: "out/soup05.png",
          story:
            "The Cosmo-Sommelier, the Ladle itself, tastes fermented dark matter ‚Äì a spicy delicacy from beyond the veil. This discovery pushes the boundaries of what can be considered 'flavor'.",
          unlockCondition: (game) =>
            game.domains.soup?.unlockedLoreLevel >= 5 &&
            game.getResource("flavorQuark") >= 10000,
        },
        {
          id: "soup06_trophy",
          name: "Flavor Foam Creation",
          imagePath: "out/soup06.png",
          story:
            "Sheared from a swirling universe, this ethereal foam seasons newborn planets with exotic tastes. It's a reminder that even the most chaotic cosmic events can yield delicious results.",
          unlockCondition: (game) =>
            game.domains.soup?.unlockedLoreLevel >= 6 &&
            game.storyFlags.soup_slurpsThisPrestige >= 2,
        },
        {
          id: "soup07_trophy",
          name: "The Omniversal Slurp",
          imagePath: "out/soup07.png",
          story:
            "A Big Slurp echoes across dimensions, vacuuming resource streams into a shimmering cosmic soup. The Ladle's ultimate expression of culinary dominance, a taste of everything, all at once.",
          unlockCondition: (game) =>
            game.domains.soup?.unlockedLoreLevel >= 8 &&
            (game.domains.soup?.generators.reduce((s, g) => s + g.level, 0) ||
              0) >= 25,
        },
        // Bureaucratic Afterlives
        {
          id: "afterlives01_trophy",
          name: "Infinite In-Tray",
          imagePath: "out/afterlives01.png",
          story:
            "Spectral paperwork stretches to infinity, a testament to eternal bureaucracy. Each form, a soul's journey, meticulously (and slowly) processed in Clerical Purgatoria.",
          unlockCondition: (game) =>
            game.getResource("existentialStamp") >= 200 &&
            game.domains.afterlives?.unlockedLoreLevel >= 1,
        },
        {
          id: "afterlives02_trophy",
          name: "Paperclips of Binding",
          imagePath: "out/afterlives02.png",
          story:
            "Ghastly staplers, once tools of chaos, are now silenced by glowing green paperclips. These simple items maintain order among the spectral workforce, ensuring the endless flow of forms.",
          unlockCondition: (game) =>
            game.domains.afterlives?.generators.find(
              (g) => g.id === "soulClerk"
            )?.level >= 3 && game.domains.afterlives?.unlockedLoreLevel >= 2,
        },
        {
          id: "afterlives03_trophy",
          name: "Debt-Gremlin Audit",
          imagePath: "out/afterlives03.png",
          story:
            "An audit spirit, clad in a spectral visor, conjures mischievous debt-gremlins from piles of cosmic red tape. Their purpose: to ensure every soul pays its existential dues.",
          unlockCondition: (game) =>
            game.storyFlags.afterlives_castAuditRivalOnce &&
            game.domains.afterlives?.unlockedLoreLevel >= 3,
        },
        {
          id: "afterlives04_trophy",
          name: "Quantum Paperwork Paradox",
          imagePath: "out/afterlives04.png",
          story:
            "A form simultaneously approved and denied, its fate sealed by overlapping, translucent stamps. This bureaucratic singularity is a common hazard in the higher (or lower) offices of Purgatoria.",
          unlockCondition: (game) =>
            game.domains.afterlives?.unlockedLoreLevel >= 4 &&
            (game.domains.afterlives?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 10,
        },
        {
          id: "afterlives05_trophy",
          name: "GhOST Local 404",
          imagePath: "out/afterlives05.png",
          story:
            "The spectral union, Ghastly Office & Spirit Technicians Local 404, meets to debate bylaws around a levitating coffee pot. Even in the afterlife, workers' rights (and coffee breaks) are paramount.",
          unlockCondition: (game) =>
            game.domains.afterlives?.unlockedLoreLevel >= 5 &&
            game.getResource("existentialStamp") >= 10000,
        },
        {
          id: "afterlives06_trophy",
          name: "Soul Queue Lobby",
          imagePath: "out/afterlives06.png",
          story:
            "Translucent souls queue beneath endless escalators, patiently awaiting their turn in the great beyond. The Bureau's main lobby is a sight of solemn, organized eternity.",
          unlockCondition: (game) =>
            game.domains.afterlives?.unlockedLoreLevel >= 6 &&
            game.storyFlags.afterlives_auditedRivals.size >= 3,
        },
        {
          id: "afterlives07_trophy",
          name: "Metaphysical Compliance",
          imagePath: "out/afterlives07.png",
          story:
            "The Under-Secretary of Metaphysical Compliance signs cosmic tax forms, each stroke dripping with stardust and authority. This is the pinnacle of afterlife administration, where universal laws are ratified.",
          unlockCondition: (game) =>
            game.domains.afterlives?.unlockedLoreLevel >= 8 &&
            (game.domains.afterlives?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 25,
        },
        // Fractal Friend Factory
        {
          id: "fractals01_trophy",
          name: "M√∂bius Whiskers",
          imagePath: "out/fractals01.png",
          story:
            "The cat 'Whiskers,' a being of pure geometry, chases its own tail through an infinite mirror corridor. A purrfect paradox, embodying the Factory's obsession with self-similarity.",
          unlockCondition: (game) =>
            game.getResource("symmetryShard") >= 200 &&
            game.domains.fractals?.unlockedLoreLevel >= 1,
        },
        {
          id: "fractals02_trophy",
          name: "Recursive Clay Forge",
          imagePath: "out/fractals02.png",
          story:
            "Tessellators, the artisans of this domain, sculpt self-replicating pets from recursive clay on kaleidoscopic anvils. Each creation is a gateway to infinite, smaller companions.",
          unlockCondition: (game) =>
            game.domains.fractals?.generators.find((g) => g.id === "fractalPet")
              ?.level >= 3 && game.domains.fractals?.unlockedLoreLevel >= 2,
        },
        {
          id: "fractals03_trophy",
          name: "Infinite Egg Hatchery",
          imagePath: "out/fractals03.png",
          story:
            "In the Symmetry Hatchery, pet eggs nest within larger eggs, ad infinitum. This recursive nesting is the core principle of the Factory's production line, a source of endless Shards.",
          unlockCondition: (game) =>
            game.storyFlags.fractals_castRecursiveSwarmOnce &&
            game.domains.fractals?.unlockedLoreLevel >= 3,
        },
        {
          id: "fractals04_trophy",
          name: "Factory Inversion",
          imagePath: "out/fractals04.png",
          story:
            "A critical recursion error causes the factory to fold inside out. Workers, unfazed, surf waves of shimmering, psychedelic geometry, a common occupational hazard.",
          unlockCondition: (game) =>
            game.domains.fractals?.unlockedLoreLevel >= 4 &&
            (game.domains.fractals?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 10,
        },
        {
          id: "fractals05_trophy",
          name: "Negative-Dimension Vault",
          imagePath: "out/fractals05.png",
          story:
            "A vault of impossible hypercubes, storing Symmetry Shards beyond the confines of normal space. This breakthrough allows the Factory to accumulate vast reserves of fractal energy.",
          unlockCondition: (game) =>
            game.domains.fractals?.unlockedLoreLevel >= 5 &&
            game.getResource("symmetryShard") >= 10000,
        },
        {
          id: "fractals06_trophy",
          name: "Antifractal Shield",
          imagePath: "out/fractals06.png",
          story:
            "Antifractal defenses neutralize hostile buffs, their white noise cancelling vibrant fractal waves. A necessary innovation to protect the Factory's delicate patterns from external interference.",
          unlockCondition: (game) =>
            game.domains.fractals?.unlockedLoreLevel >= 6 &&
            Game.realityStrain >= Game.maxRealityStrain * 0.5,
        },
        {
          id: "fractals07_trophy",
          name: "Pet Micro-Civilization",
          imagePath: "out/fractals07.png",
          story:
            "Within each fractal pet, a tiny, complex society thrives, debating laws in a crystal metropolis. The Factory's creations are not just pets, but entire recursive universes.",
          unlockCondition: (game) =>
            game.domains.fractals?.unlockedLoreLevel >= 8 &&
            (game.domains.fractals?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 25,
        },
        // Time-Traveling Snack Bar
        {
          id: "snackbar01_trophy",
          name: "Dino-Burger Dash",
          imagePath: "out/snackbar01.png",
          story:
            "The Era Food Truck, parked precariously during a dinosaur stampede, serves chrono-burgers to surprised velociraptors. A typical Tuesday for the Snack Bar crew, always chasing the most exotic clientele.",
          unlockCondition: (game) =>
            game.getResource("chronoTip") >= 200 &&
            game.domains.snackbar?.unlockedLoreLevel >= 1,
        },
        {
          id: "snackbar02_trophy",
          name: "Yesterday's Fries, Today",
          imagePath: "out/snackbar02.png",
          story:
            "The temporal deep-fryer, a marvel of chrono-culinary engineering, ensures fries cooked yesterday are perfectly golden and cool today. This innovation revolutionized the concept of 'fast food'.",
          unlockCondition: (game) =>
            game.domains.snackbar?.generators.find(
              (g) => g.id === "eraFoodTruck"
            )?.level >= 3 && game.domains.snackbar?.unlockedLoreLevel >= 2,
        },
        {
          id: "snackbar03_trophy",
          name: "Future-Tomato Ketchup",
          imagePath: "out/snackbar03.png",
          story:
            "Holographic chrono-condiments, like ketchup made from tomatoes yet to ripen, are a staple. These pre-cogs (pre-condiments?) offer a taste of what's to come, quite literally.",
          unlockCondition: (game) =>
            game.storyFlags.snackbar_castParadoxSurgeOnce &&
            game.domains.snackbar?.unlockedLoreLevel >= 3,
        },
        {
          id: "snackbar04_trophy",
          name: "Epoch-Spanning Ramen",
          imagePath: "out/snackbar04.png",
          story:
            "A bowl of Entropy Ramen, served simultaneously hot and cold across different eras. Eating it is a disorienting but delicious experience, a favorite among seasoned time travelers.",
          unlockCondition: (game) =>
            game.domains.snackbar?.unlockedLoreLevel >= 4 &&
            (game.domains.snackbar?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 10,
        },
        {
          id: "snackbar05_trophy",
          name: "32nd Century Health Inspection",
          imagePath: "out/snackbar05.png",
          story:
            "Inspectors from 3128 AD, armed with laser clipboards, scan an archaic grill, ensuring temporal hygiene. The Snack Bar always passes, thanks to its meticulous (and anachronistic) cleaning protocols.",
          unlockCondition: (game) =>
            game.domains.snackbar?.unlockedLoreLevel >= 5 &&
            game.getResource("chronoTip") >= 10000,
        },
        {
          id: "snackbar06_trophy",
          name: "Paradoxical Sign Reset",
          imagePath: "out/snackbar06.png",
          story:
            "A Paradox Surge, a common side effect of temporal tinkering, crashes the system, resetting the neon sign's numbers backward in a flash of temporal lightning. Just another day at the office.",
          unlockCondition: (game) =>
            game.domains.snackbar?.unlockedLoreLevel >= 6 &&
            game.storyFlags.snackbar_surgesThisPrestige >= 2,
        },
        {
          id: "snackbar07_trophy",
          name: "Omnipresent Food Truck Fleet",
          imagePath: "out/snackbar07.png",
          story:
            "A fleet of Era Food Trucks, existing simultaneously across all timelines, a testament to the Snack Bar's ultimate mastery of temporal omnipresence. Service anytime, anywhen.",
          unlockCondition: (game) =>
            game.domains.snackbar?.unlockedLoreLevel >= 8 &&
            (game.domains.snackbar?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 25,
        },
        // Emotion Mining Co.
        {
          id: "emotions01_trophy",
          name: "Joy Crystal Cavern",
          imagePath: "out/emotions01.png",
          story:
            "Deep within the Sentient Stratum, miners extract raw Joy from glowing caverns. Here, feelings manifest as vibrant, tangible crystals, the primary resource of this empathic domain.",
          unlockCondition: (game) =>
            game.getResource("vibeOre") >= 200 &&
            game.domains.emotions?.unlockedLoreLevel >= 1,
        },
        {
          id: "emotions02_trophy",
          name: "Mirrored Regret Gas",
          imagePath: "out/emotions02.png",
          story:
            "Volatile Regret Gas swirls within the mirrored helmets of miners. This dangerous substance is a potent reminder of 'what could have been,' carefully handled to prevent psychic feedback loops.",
          unlockCondition: (game) =>
            game.domains.emotions?.generators.find(
              (g) => g.id === "empathyReactor"
            )?.level >= 3 && game.domains.emotions?.unlockedLoreLevel >= 2,
        },
        {
          id: "emotions03_trophy",
          name: "Vibe Alloy Reactor",
          imagePath: "out/emotions03.png",
          story:
            "The Empathy Reactor's core refines raw sentiment into Vibe Alloy, a psycho-reactive metal pulsing with heart-shaped energy. This alloy is coveted across the Conflux for its unique properties.",
          unlockCondition: (game) =>
            game.storyFlags.emotions_castSerenityFieldOnce &&
            game.domains.emotions?.unlockedLoreLevel >= 3,
        },
        {
          id: "emotions04_trophy",
          name: "Subconscious Megafauna",
          imagePath: "out/emotions04.png",
          story:
            "On the Subconscious Plateau, archetypal megafauna ‚Äì manifestations of collective dreams and fears ‚Äì roam a surreal, vibrant dreamscape. Their moods directly influence Vibe Ore production.",
          unlockCondition: (game) =>
            game.domains.emotions?.unlockedLoreLevel >= 4 &&
            (game.domains.emotions?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 10,
        },
        {
          id: "emotions05_trophy",
          name: "Serene Cloud Field",
          imagePath: "out/emotions05.png",
          story:
            "A Serenity Field, generated by advanced empathic technology, calms chaotic feelings into tranquil pastel clouds. This bubble of pure peace is a refuge and a powerful production booster.",
          unlockCondition: (game) =>
            game.domains.emotions?.unlockedLoreLevel >= 5 &&
            game.getResource("vibeOre") >= 10000,
        },
        {
          id: "emotions06_trophy",
          name: "Sepia-Toned Nostalgia Vein",
          imagePath: "out/emotions06.png",
          story:
            "Miners tap into the Nostalgia Vein, their visor surfaces shimmering with sepia-toned memories. This potent, bittersweet emotion is a rare and valuable form of Vibe Ore.",
          unlockCondition: (game) =>
            game.domains.emotions?.unlockedLoreLevel >= 6 &&
            Game.entropyTokens >= 10,
        },
        {
          id: "emotions07_trophy",
          name: "Psycho-Crystal Bloom",
          imagePath: "out/emotions07.png",
          story:
            "The Sentient Stratum, fully terraformed by emotional energy, blooms into a psychedelic Psycho-Crystal Garden. This ultimate state of empathic resonance radiates powerful vibes across the Conflux.",
          unlockCondition: (game) =>
            game.domains.emotions?.unlockedLoreLevel >= 8 &&
            (game.domains.emotions?.generators.reduce(
              (s, g) => s + g.level,
              0
            ) || 0) >= 25,
        },
      ];

      function renderTrophy(trophy) {
        const isUnlocked = Game.unlockedTrophies.has(trophy.id);
        const trophyEl = document.createElement("div");
        trophyEl.id = `trophy-${trophy.id}`;
        // Add 'tooltip' class to enable existing CSS for hover-based visibility
        trophyEl.className = "trophy-item tooltip";
        if (!isUnlocked) {
          trophyEl.classList.add("locked");
        }

        const tooltipText = document.createElement("span");
        tooltipText.className = "trophy-tooltiptext"; // Use the new specific class

        if (isUnlocked) {
          const img = document.createElement("img");
          img.src = trophy.imagePath;
          img.alt = trophy.name;
          trophyEl.appendChild(img);
          tooltipText.innerHTML = `<strong>${trophy.name}</strong>${trophy.story}`;
        } else {
          // For locked trophies, the ::after pseudo-element shows the '?' on the main icon.
          // The tooltip will now show the actual image and story.
          // No main img tag is needed in trophyEl for locked items.
          tooltipText.innerHTML = `
            <img src="${trophy.imagePath}" alt="${trophy.name}" style="width: 60px; height: 60px; margin-bottom: 8px; border-radius: 4px; display: block; margin-left: auto; margin-right: auto;">
            <strong>${trophy.name} (Locked)</strong>
            ${trophy.story}`;
        }

        trophyEl.appendChild(tooltipText);

        // Add click listener to show the individual trophy unlock modal (which is more like a detail view now)
        trophyEl.addEventListener('click', () => {
            // If the main gallery modal is open, clicking a trophy inside it
            // should show the detailed "unlock" modal for that trophy.
            showTrophyUnlockModal(trophy); 
        });

        return trophyEl;
      }

      function renderAllTrophies() {
        const container = document.getElementById("gallery-modal-trophies-container"); // Target new container in modal
        if (!container) return;
        container.innerHTML = ""; // Clear existing trophies
        TROPHIES.forEach((trophy) => {
          container.appendChild(renderTrophy(trophy));
        });
      }

      function checkAndUnlockTrophies() {
        let newUnlockOccurred = false;
        TROPHIES.forEach((trophy) => {
          if (
            !Game.unlockedTrophies.has(trophy.id) &&
            trophy.unlockCondition(Game)
          ) {
            Game.unlockedTrophies.add(trophy.id);
            Bus.emit("trophy:unlocked", trophy);
            saveGame(); // Auto-save when a trophy is unlocked
            newUnlockOccurred = true;
          }
        });
        // Re-render the whole gallery if any new trophy was unlocked.
        // For more performance, one could update only the changed trophy elements.
        if (newUnlockOccurred) {
          renderAllTrophies();
        }
      }

      // --- DOMAIN UNLOCK LOGIC ---
      const DOMAIN_INTRO_AUDIO = {
        "gardeners": "out_audio/gardeners_01_intro.mp3", // Often tied to initial game start
        "soundwaves": "out_audio/soundwaves_01_intro.mp3",
        "emotions": "out_audio/emotions_01_intro.mp3",
        "soup": "out_audio/soup_01_intro.mp3",
        "snackbar": "out_audio/snackbar_01_intro.mp3",
        "fractals": "out_audio/fractals_01_intro.mp3",
        "afterlives": "out_audio/afterlives_01_intro.mp3"
      };

      function checkAndUnlockNextDomain() {
        let previousDomainId = null;
        let newDomainUnlockedThisTick = false;

        const domainsToConsider = Game.prestigeCount === 0 
            ? DOMAIN_UNLOCK_ORDER.slice(0, 4) // Only first 4 domains if no prestige yet
            : DOMAIN_UNLOCK_ORDER;

        for (const domainId of domainsToConsider) {
            const domain = Game.domains[domainId];
            if (!domain) {
                console.warn(`Domain ${domainId} not found in Game.domains during unlock check.`);
                continue;
            }

            if (domain.unlocked) {
                previousDomainId = domainId;
                continue; 
            }

            if (domainId === DOMAIN_UNLOCK_ORDER[0]) { // First domain
                if (!domain.unlocked) { // Should be unlocked by defineDomain
                    domain.unlocked = true;
                    Bus.emit("domain:unlocked", { domainId, isInitialUnlock: true });
                    newDomainUnlockedThisTick = true;
                }
                previousDomainId = domainId;
                continue;
            }
            
            if (!previousDomainId) {
                console.error("Unlock logic error: No previous unlocked domain found for", domainId);
                break; 
            }

            const prevDomain = Game.domains[previousDomainId];
            if (!prevDomain) {
                 console.error(`Previous domain ${previousDomainId} not found for unlocking ${domainId}`);
                 break;
            }

            let conditionMet = false;
            if (domainId === "soundwaves" && prevDomain.id === "gardeners") {
                conditionMet = prevDomain.generators.find(g => g.id === 'timelineBloomer')?.level >= 5;
            } else if (domainId === "emotions" && prevDomain.id === "soundwaves") {
                conditionMet = prevDomain.generators.find(g => g.id === 'cosmicArtist')?.level >= 5;
            } else if (domainId === "soup" && prevDomain.id === "emotions") {
                conditionMet = prevDomain.generators.find(g => g.id === 'empathyReactor')?.level >= 5;
            } else if (domainId === "snackbar" && prevDomain.id === "soup") {
                conditionMet = prevDomain.generators.find(g => g.id === 'primordialBroth')?.level >= 5;
            } else if (domainId === "fractals" && prevDomain.id === "snackbar") {
                conditionMet = prevDomain.generators.find(g => g.id === 'eraFoodTruck')?.level >= 5;
            } else if (domainId === "afterlives" && prevDomain.id === "fractals") {
                conditionMet = prevDomain.generators.find(g => g.id === 'fractalPet')?.level >= 5;
            }

            if (conditionMet) {
                domain.unlocked = true;
                Bus.emit("domain:unlocked", { domainId, isInitialUnlock: false });
                newDomainUnlockedThisTick = true;
                previousDomainId = domainId; 
            } else {
                break; 
            }
        }
        if (newDomainUnlockedThisTick) {
            renderAllDomains(); // Re-render if any domain was unlocked
        }
      }


      // --- TUTORIAL MANAGER ---
      const TutorialManager = (() => {
        const tutorialSteps = [
          {
            id: "clickFirstDomain",
            trigger: (game) =>
              game.t > 1500 && !game.tutorialFlags.clickedFirstDomain,
            selector: "#click-gardeners",
            message:
              'Welcome, Shaper! Click here on "Quantum Gardeners" to gather your first Probability Petals.',
            onComplete: (game) =>
              (game.tutorialFlags.clickedFirstDomain = true),
            position: "bottom",
          },
          {
            id: "buyFirstGenerator",
            trigger: (game) =>
              game.tutorialFlags.clickedFirstDomain &&
              game.getResource("probabilityPetal") >= 10 &&
              !game.domains.gardeners?.generators.find(
                (g) => g.id === "timelineBloomer"
              )?.level &&
              !game.tutorialFlags.boughtFirstGenerator,
            selector: "#buy-gen-gardeners-timelineBloomer",
            message:
              'Great! Now spend 10 Petals to buy a "Timeline Bloomer". It generates Petals for you automatically!',
            onComplete: (game) =>
              (game.tutorialFlags.boughtFirstGenerator = true),
            position: "bottom",
          },
          {
            id: "castFirstAbility",
            trigger: (game) =>
              game.tutorialFlags.boughtFirstGenerator &&
              game.getResource("probabilityPetal") >=
                Game.domains.gardeners?.abilities.find(
                  (a) => a.id === "collapseCertainty"
                )?.cost?.probabilityPetal &&
              !game.tutorialFlags.castFirstAbility,
            selector: "#cast-ab-gardeners-collapseCertainty",
            message:
              'Abilities can give you an edge. When you have enough Petals, try casting "Collapse Certainty". (It needs a target!)',
            onComplete: (game) => (game.tutorialFlags.castFirstAbility = true),
            position: "top",
          },
          {
            id: "prestigeHint",
            trigger: (game) =>
              game.realityStrain >= Game.maxRealityStrain * 0.3 &&
              game.prestigeCount === 0 &&
              !game.tutorialFlags.sawPrestigeHint, // Show hint earlier
            selector: "#prestige-button",
            message:
              'See "Reality Strain" (top bar)? When it\'s full, "Conflux Collapse!" becomes active. This resets progress but gives powerful Entropy Tokens!',
            onComplete: (game) => (game.tutorialFlags.sawPrestigeHint = true),
            position: "top",
          },
        ];
        let currentStepIndex = 0;
        let activeCoachMarkElements = null;
        const coachMarkContainer = document.getElementById(
          "coach-mark-overlay-container"
        );

        function displayStep(step) {
          if (activeCoachMarkElements || !coachMarkContainer) return; // Already showing or no container

          const targetElement = document.querySelector(step.selector);
          if (!targetElement) {
            console.warn(
              `Tutorial: Target element not found for selector: ${step.selector}`
            );
            // Potentially advance to next step or wait
            return;
          }

          coachMarkContainer.innerHTML = ""; // Clear previous

          // Create message box
          const messageBox = document.createElement("div");
          messageBox.className = "coach-mark-message-box";
          messageBox.innerHTML = `<p class="mb-3 text-sm">${step.message}</p><button id="coach-got-it" class="btn btn-primary btn-sm w-full">Got it!</button>`;

          // Position message box (simple logic, can be improved)
          const targetRect = targetElement.getBoundingClientRect();
          if (step.position === "top") {
            messageBox.style.bottom = `${
              window.innerHeight - targetRect.top + 10
            }px`;
          } else {
            // Default bottom
            messageBox.style.top = `${targetRect.bottom + 10}px`;
          }
          messageBox.style.left = `${
            targetRect.left + targetRect.width / 2 - messageBox.offsetWidth / 2
          }px`;
          // Ensure it's within viewport horizontally
          if (
            targetRect.left +
              targetRect.width / 2 -
              messageBox.offsetWidth / 2 <
            0
          ) {
            messageBox.style.left = "10px";
          } else if (
            targetRect.left +
              targetRect.width / 2 +
              messageBox.offsetWidth / 2 >
            window.innerWidth
          ) {
            messageBox.style.left = `${
              window.innerWidth - messageBox.offsetWidth - 10
            }px`;
          }

          coachMarkContainer.appendChild(messageBox);
          targetElement.classList.add(
            "coach-mark-highlight",
            "coach-mark-highlight-pulsate"
          );

          activeCoachMarkElements = { targetElement, messageBox };

          document
            .getElementById("coach-got-it")
            .addEventListener("click", () => {
              advanceStepIfCurrent(step.id);
            });
        }

        function clearCurrentStepDisplay() {
          if (activeCoachMarkElements) {
            activeCoachMarkElements.targetElement.classList.remove(
              "coach-mark-highlight",
              "coach-mark-highlight-pulsate"
            );
            if (activeCoachMarkElements.messageBox.parentNode) {
              activeCoachMarkElements.messageBox.parentNode.removeChild(
                activeCoachMarkElements.messageBox
              );
            }
          }
          if (coachMarkContainer) coachMarkContainer.innerHTML = ""; // Clear container fully
          activeCoachMarkElements = null;
        }

        function advanceStepIfCurrent(completedStepId) {
          if (
            currentStepIndex < tutorialSteps.length &&
            tutorialSteps[currentStepIndex].id === completedStepId
          ) {
            const step = tutorialSteps[currentStepIndex];
            if (step.onComplete) step.onComplete(Game);

            clearCurrentStepDisplay();
            currentStepIndex++;
            checkState(); // Check for the next step immediately
          }
        }

        function checkState() {
          if (localStorage.getItem("tutorialFullyCompleted_v1")) return;

          // Check if the currently displayed step's trigger is still valid
          if (activeCoachMarkElements && currentStepIndex < tutorialSteps.length) {
            const currentDisplayedStep = tutorialSteps[currentStepIndex];
            if (!currentDisplayedStep.trigger(Game)) {
              // Trigger condition became false (e.g., user prestiged), hide the current coach mark
              clearCurrentStepDisplay();
              // Don't advance, just hide. The next checkState might trigger it again if appropriate.
            }
          }

          if (currentStepIndex >= tutorialSteps.length) {
            // Check again after potential clearCurrentStepDisplay call
            if (!activeCoachMarkElements) { // Only finalize if nothing is displayed
                 localStorage.setItem("tutorialFullyCompleted_v1", "true");
                 Bus.emit("feedback:message", {
                    message: "Guided tour complete! The Conflux is yours to shape.",
                    type: "success",
                    fontClass: "font-arcade",
                 });
            }
            // The lines causing the syntax error were here and have been removed.
            clearCurrentStepDisplay(); // Ensure last coach mark is cleared
            return;
          }
          const nextStep = tutorialSteps[currentStepIndex];
          // Only display if no coach mark is currently active and the trigger is met
          if (!activeCoachMarkElements && nextStep && nextStep.trigger(Game)) {
            displayStep(nextStep);
          }
        }

        function resetForNewSession() {
          // This resets the tutorial if it wasn't fully completed globally.
          // For a "per prestige" tutorial, you'd clear tutorialFlags and reset currentStepIndex.
          if (!localStorage.getItem("tutorialFullyCompleted_v1")) {
            currentStepIndex = 0;
            Game.tutorialFlags = {}; // Reset in-session flags
            clearCurrentStepDisplay();
          }
        }

        return { checkState, advanceStepIfCurrent, resetForNewSession };
      })();

      // --- UI RENDERING AND UPDATES ---
      // (formatNumber, renderDomainCard, updateDomainUICard, renderAllDomains, updateGlobalStatsUI)
      // Largely unchanged, ensure IDs used by tutorial selectors are correct.
      const domainsContainer = document.getElementById("domains-container");
      const entropyTokensDisplay = document.getElementById(
        "entropy-tokens-display"
      );
      const realityStrainDisplay = document.getElementById(
        "reality-strain-display"
      );
      const realityStrainBar = document.getElementById("reality-strain-bar");
      const prestigeButton = document.getElementById("prestige-button");
      const prestigeTooltip = document.getElementById("prestige-tooltip"); // Get the new tooltip span
      const targetOverlay = document.getElementById("target-overlay");
      const quickStartTagline = document.getElementById("quick-start-tagline");

      function addMessageToStoryLog(messageContent, entryClass = "story-log-entry text-gray-300") {
        const storyLog = document.getElementById("story-log");
        if (!storyLog) return;

        // If the story log hasn't been "initialized" for the current session (e.g., after load/prestige),
        // clear its initial placeholder content.
        if (!storyLogInitialized) {
            storyLog.innerHTML = "";
            storyLogInitialized = true;
        }

        const entry = document.createElement("p");
        entry.className = entryClass;
        entry.innerHTML = messageContent; // Use innerHTML to support icons/formatting

        if (storyLog.firstChild) {
            storyLog.insertBefore(entry, storyLog.firstChild);
        } else {
            storyLog.appendChild(entry);
        }

        // Keep the log to a manageable size
        while (storyLog.children.length > 20) {
            storyLog.removeChild(storyLog.lastChild);
        }
      }

      function formatNumber(num) {
        if (num === undefined || num === null) return "0.00";
        if (Math.abs(num) < 0.0001 && num !== 0) return num.toExponential(2);
        if (Math.abs(num) < 1000) return num.toFixed(2);
        const s = [
          "",
          "k",
          "M",
          "B",
          "T",
          "Qa",
          "Qi",
          "Sx",
          "Sp",
          "Oc",
          "No",
          "Dc",
        ];
        const i = Math.floor(Math.log10(Math.abs(num)) / 3);
        if (i >= s.length) return num.toExponential(2);
        return (num / Math.pow(1000, i)).toFixed(2) + s[i];
      }

      function renderDomainCard(domain) {
        const card = document.createElement("div");
        card.id = `domain-${domain.id}`;
        card.className = `domain-card ${domain.cardStyleClass || ""} flex flex-col space-y-3`;
        // card.style.borderColor = domain.color || "#374151"; // Border color now handled by CSS class

        let generatorsHTML = domain.generators
          .map((gen) => {
            const effectiveCost = { ...gen.currentCost };
            if (gen.costMultiplier && gen.costMultiplier > 1) {
              for (const resId in effectiveCost)
                effectiveCost[resId] = Math.floor(
                  effectiveCost[resId] * gen.costMultiplier
                );
            }
            const costString = Object.entries(effectiveCost)
              .map(
                ([resId, amount]) =>
                  `${formatNumber(amount)} ${
                    Game.resources_map?.[resId]?.name || resId
                  }`
              )
              .join(", ");
            const genProd =
              typeof gen.baseProd === "number"
                ? gen.baseProd
                : gen.baseProd[domain.clickResource.id] || 0;
            const currentProd =
              gen.level > 0
                ? genProd *
                  gen.level *
                  Math.pow(gen.prodScaling, gen.level - 1) *
                  getGlobalProductionMultiplier()
                : 0;
            return `
                    <div class="p-2 bg-gray-700 rounded">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-sm tooltip">${
                              gen.name
                            } (Lvl ${gen.level})
                                <span class="tooltiptext">${
                                  gen.description ||
                                  "Generates resources passively."
                                }<br>Base Prod: ${formatNumber(
              genProd * gen.level * Math.pow(gen.prodScaling, gen.level - 1)
            )}/s<br>Actual Prod: ${formatNumber(currentProd)}/s</span>
                            </h4>
                            <button id="buy-gen-${domain.id}-${
              gen.id
            }" class="btn btn-secondary btn-sm text-xs">Buy (${costString})</button>
                        </div>
                        <p class="text-xs text-gray-400">Produces: ${formatNumber(
                          currentProd
                        )} ${domain.clickResource.name}/s</p>
                    </div>`;
          })
          .join("");

        let abilitiesHTML = domain.abilities
          .map((ab) => {
            const costString = ab.cost
              ? Object.entries(ab.cost)
                  .map(
                    ([resId, amount]) =>
                      `${formatNumber(amount)} ${
                        Game.resources_map?.[resId]?.name || resId
                      }`
                  )
                  .join(", ")
              : "No Cost";
            return `
                    <div class="p-2 bg-gray-700 rounded">
                        <div class="flex justify-between items-center">
                             <h4 class="font-semibold text-sm tooltip">${
                               ab.name
                             }
                                <span class="tooltiptext">${
                                  ab.description || "A special ability."
                                }<br>CD: ${
              ab.cooldownMs / 1000
            }s. Cost: ${costString}<br>Strain: ${ab.strainFactor || 1}</span>
                            </h4>
                            <button id="cast-ab-${domain.id}-${
              ab.id
            }" class="btn btn-secondary btn-sm text-xs ${
              ab.type === "aggressive"
                ? "bg-red-700 hover:bg-red-600"
                : ab.type === "defensive"
                ? "bg-sky-700 hover:bg-sky-600"
                : ab.type === "utility"
                ? "bg-yellow-600 hover:bg-yellow-500"
                : ""
            }">Cast</button>
                        </div>
                        <div class="text-xs text-gray-400">Cooldown: <span id="cd-${
                          domain.id
                        }-${ab.id}">${(ab.nextUse > Game.t
              ? (ab.nextUse - Game.t) / 1000
              : 0
            ).toFixed(1)}s</span></div>
                    </div>`;
          })
          .join("");

        card.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-bold font-arcade" style="color: ${
                      domain.color || "#FFF"
                    }">${domain.name}</h3>
                    <div class="text-xs text-gray-400 tooltip">Lvl ${
                      domain.level
                    }<span class="tooltiptext">${
          domain.description || "A unique domain."
        }</span></div>
                </div>
                <button id="click-${
                  domain.id
                }" class="btn btn-primary w-full py-3 font-arcade text-lg">Gather ${
          domain.clickResource.name
        }</button>
                <p class="text-center resource-display">${
                  domain.clickResource.name
                }: <span id="res-${
          domain.clickResource.id
        }" class="font-bold text-lg">${formatNumber(
          Game.getResource(domain.clickResource.id)
        )}</span></p>
                ${
                  generatorsHTML
                    ? `<div class="space-y-2"><h5>Generators:</h5>${generatorsHTML}</div>`
                    : ""
                }
                ${
                  abilitiesHTML
                    ? `<div class="space-y-2"><h5>Abilities:</h5>${abilitiesHTML}</div>`
                    : ""
                }
                <button id="lore-${
                  domain.id
                }" class="btn btn-secondary btn-sm text-xs mt-1 w-full bg-purple-700 hover:bg-purple-600">View Lore</button>`;

        domainsContainer.appendChild(card);

        document
          .getElementById(`click-${domain.id}`)
          .addEventListener("click", (event) => {
            clickDomain(domain.id); // Game logic
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            let clickGain =
              domain.clickResource.baseAmount *
              (1 + Game.entropyTokens * 0.005);
            Game.buffs.forEach((buff) => {
              if (
                buff.affects === "click" &&
                (!buff.domainId || buff.domainId === domain.id)
              )
                clickGain *= buff.multiplier || 1;
            });
            Bus.emit("feedback:click_visual", {
              element: event.target,
              x,
              y,
              text: `+${formatNumber(clickGain)}`,
            });
          });
        domain.generators.forEach((gen) => {
          const btn = document.getElementById(`buy-gen-${domain.id}-${gen.id}`);
          if (btn)
            btn.addEventListener("click", () =>
              buyGenerator(domain.id, gen.id)
            );
        });
        domain.abilities.forEach((ab) => {
          const btn = document.getElementById(`cast-ab-${domain.id}-${ab.id}`);
          if (btn)
            btn.addEventListener("click", () => castAbility(domain.id, ab.id));
        });
        const loreButton = document.getElementById(`lore-${domain.id}`);
        if (loreButton)
          loreButton.addEventListener("click", () => showLoreModal(domain.id));
        card.addEventListener("click", () => {
          if (
            Game.activeTargeting &&
            Game.activeTargeting.casterId !== domain.id
          )
            castAbility(
              Game.activeTargeting.casterId,
              Game.activeTargeting.abilityId,
              domain.id
            );
        });
      }

      function updateDomainUICard(domainId) {
        // ... (This function is complex and mostly unchanged, ensure selectors are accurate for tutorial)
        // Key is to ensure buttons are correctly enabled/disabled for tutorial triggers.
        const domain = Game.domains[domainId];
        if (!domain) return;
        const card = document.getElementById(`domain-${domainId}`);
        if (!card) return;
        const resDisplay = document.getElementById(
          `res-${domain.clickResource.id}`
        );
        if (resDisplay)
          resDisplay.textContent = formatNumber(
            Game.getResource(domain.clickResource.id)
          );
        const levelDisplay = card.querySelector(
          ".text-xs.text-gray-400.tooltip"
        );
        if (levelDisplay)
          levelDisplay.childNodes[0].nodeValue = `Lvl ${domain.level}`;
        domain.generators.forEach((gen) => {
          const genLvlDisplay = card.querySelector(
            `#buy-gen-${domain.id}-${gen.id}`
          )?.previousElementSibling?.childNodes[0];
          if (genLvlDisplay)
            genLvlDisplay.nodeValue = `${gen.name} (Lvl ${gen.level}) `;
          const effectiveCost = { ...gen.currentCost };
          if (gen.costMultiplier && gen.costMultiplier > 1) {
            for (const resId in effectiveCost)
              effectiveCost[resId] = Math.floor(
                effectiveCost[resId] * gen.costMultiplier
              );
          }
          const costString = Object.entries(effectiveCost)
            .map(
              ([resId, amount]) =>
                `${formatNumber(amount)} ${
                  Game.resources_map?.[resId]?.name || resId
                }`
            )
            .join(", ");
          const buyBtn = document.getElementById(
            `buy-gen-${domain.id}-${gen.id}`
          );
          if (buyBtn) {
            buyBtn.textContent = `Buy (${costString})`;
            let canAfford = true;
            for (const resId in effectiveCost) {
              if (Game.getResource(resId) < effectiveCost[resId]) {
                canAfford = false;
                break;
              }
            }
            buyBtn.disabled = !canAfford;
            buyBtn.classList.toggle("btn-disabled", !canAfford);
            if (canAfford) buyBtn.classList.remove("btn-disabled");
            else buyBtn.classList.add("btn-disabled");
          }
          const genProd =
            typeof gen.baseProd === "number"
              ? gen.baseProd
              : gen.baseProd[domain.clickResource.id] || 0;
          const currentProd =
            gen.level > 0
              ? genProd *
                gen.level *
                Math.pow(gen.prodScaling, gen.level - 1) *
                getGlobalProductionMultiplier()
              : 0;
          const genTooltip = card
            .querySelector(`#buy-gen-${domain.id}-${gen.id}`)
            ?.previousElementSibling?.querySelector(".tooltiptext");
          if (genTooltip)
            genTooltip.innerHTML = `${
              gen.description || "Generates resources passively."
            }<br>Base Prod: ${formatNumber(
              genProd * gen.level * Math.pow(gen.prodScaling, gen.level - 1)
            )}/s<br>Actual Prod: ${formatNumber(currentProd)}/s`;
          const prodDisplay = card.querySelector(
            `#buy-gen-${domain.id}-${gen.id}`
          )?.parentElement?.nextElementSibling;
          if (prodDisplay)
            prodDisplay.textContent = `Produces: ${formatNumber(currentProd)} ${
              domain.clickResource.name
            }/s`;
        });
        domain.abilities.forEach((ab) => {
          const cdDisplay = document.getElementById(`cd-${domain.id}-${ab.id}`);
          const timeLeft =
            ab.nextUse > Game.t ? (ab.nextUse - Game.t) / 1000 : 0;
          if (cdDisplay) cdDisplay.textContent = timeLeft.toFixed(1) + "s";
          const castBtn = document.getElementById(
            `cast-ab-${domain.id}-${ab.id}`
          );
          if (castBtn) {
            let canAfford = true;
            if (ab.cost) {
              for (const resId in ab.cost) {
                if (Game.getResource(resId) < ab.cost[resId]) {
                  canAfford = false;
                  break;
                }
              }
            }
            castBtn.disabled = timeLeft > 0 || !canAfford;
            castBtn.classList.toggle(
              "btn-disabled",
              timeLeft > 0 || !canAfford
            );
            // Manage specific button styling if not disabled
            if (!(timeLeft > 0 || !canAfford)) {
              castBtn.classList.remove("btn-disabled");
              castBtn.classList.remove("bg-gray-700", "hover:bg-gray-600"); // remove base secondary
              if (ab.type === "aggressive")
                castBtn.classList.add("bg-red-700", "hover:bg-red-600");
              else if (ab.type === "defensive")
                castBtn.classList.add("bg-sky-700", "hover:bg-sky-600");
              else if (ab.type === "utility")
                castBtn.classList.add("bg-yellow-600", "hover:bg-yellow-500");
              else castBtn.classList.add("bg-gray-700", "hover:bg-gray-600"); // default if no specific type
            } else {
              // Is disabled
              castBtn.classList.add("btn-disabled");
              // Remove specific type styling when disabled
              castBtn.classList.remove(
                "bg-red-700",
                "hover:bg-red-600",
                "bg-sky-700",
                "hover:bg-sky-600",
                "bg-yellow-600",
                "hover:bg-yellow-500"
              );
            }
          }
        });
      }
      function renderAllDomains() {
        domainsContainer.innerHTML = "";
        DOMAIN_UNLOCK_ORDER.forEach(domainId => {
            const domain = Game.domains[domainId];
            if (domain && domain.unlocked) {
                renderDomainCard(domain);
            }
        });
        // After rendering, ensure UI for all *visible* cards is up-to-date
        DOMAIN_UNLOCK_ORDER.forEach(domainId => {
            const domain = Game.domains[domainId];
            if (domain && domain.unlocked) {
                 updateDomainUICard(domainId); // Refresh UI for newly rendered cards
            }
        });
      }
      function updateGlobalStatsUI() {
        if (entropyTokensDisplay)
          entropyTokensDisplay.textContent = formatNumber(Game.entropyTokens);
        if (realityStrainDisplay)
          realityStrainDisplay.textContent = `${Game.realityStrain.toFixed(
            2
          )} / ${Game.maxRealityStrain}`;
        if (realityStrainBar)
          realityStrainBar.style.width = `${
            (Game.realityStrain / Game.maxRealityStrain) * 100
          }%`;
        if (prestigeButton) {
          prestigeButton.disabled = Game.realityStrain < Game.maxRealityStrain;
          prestigeButton.classList.toggle(
            "btn-disabled",
            Game.realityStrain < Game.maxRealityStrain
          );
          prestigeButton.classList.toggle(
            "animate-pulse",
            Game.realityStrain >= Game.maxRealityStrain
          );
          if (Game.realityStrain >= Game.maxRealityStrain) {
            prestigeButton.classList.remove(
              "bg-indigo-600",
              "hover:bg-indigo-700"
            );
            prestigeButton.classList.add("bg-red-500", "hover:bg-red-600");
          } else {
            prestigeButton.classList.add(
              "bg-indigo-600",
              "hover:bg-indigo-700"
            );
            prestigeButton.classList.remove("bg-red-500", "hover:bg-red-600");
          }

          // Update prestige button tooltip
          if (prestigeTooltip) {
            const tokensToEarn = Math.floor(
              1 +
              Game.prestigeCount * 0.5 +
              Object.values(Game.domains).reduce(
                (sum, d) => sum + d.generators.reduce((s, g) => s + g.level, 0),
                0
              ) / 20
            );
            let tooltipHTML = `
              <strong>Perform a Conflux Collapse!</strong><br>
              Resets your current progress (resources, generator levels, domain unlocks) but grants powerful <strong style="color: #A78BFA;">Entropy Tokens</strong>.<br><br>
              You will earn: <strong style="color: #FCD34D;">${tokensToEarn}</strong> Entropy Token(s) this collapse.<br><br>
              Each Entropy Token grants:<br>
              - <strong style="color: #6EE7B7;">+1%</strong> Global Production Rate<br>
              - <strong style="color: #6EE7B7;">+0.5%</strong> Global Click Power<br><br>
              Current Total: <strong style="color: #A78BFA;">${Game.entropyTokens}</strong> Tokens (+${Game.entropyTokens}% Prod, +${(Game.entropyTokens * 0.5).toFixed(1)}% Click)
            `;
            if (Game.realityStrain < Game.maxRealityStrain) {
              tooltipHTML = `Reach 100% Reality Strain to enable Conflux Collapse.<br><br>` + tooltipHTML;
            }
            prestigeTooltip.innerHTML = tooltipHTML;
          }
        }
      }

      // --- EVENT LISTENERS FOR UI ---
      // (Bus.on resource:update, generator:bought, ability:cast, buff:added/expired, tick, realityStrain:update, game:prestiged, ability:targeting_started/ended, feedback:message, feedback:click_visual)
      // These are mostly unchanged but crucial for UI reactivity.
      Bus.on("resource:update", () =>
        Object.values(Game.domains).forEach((d) => updateDomainUICard(d.id))
      );
      Bus.on("generator:bought", (p) => {
        Game.domains[p.domainId].level = Game.domains[
          p.domainId
        ].generators.reduce((s, gen) => s + gen.level, 0);
        updateDomainUICard(p.domainId);
      });
      Bus.on("ability:cast", (p) => {
        updateDomainUICard(p.casterDomainId);
        if (p.targetDomainId) updateDomainUICard(p.targetDomainId);
      });
      Bus.on("buff:added", (b) => {
        if (b.domainId) updateDomainUICard(b.domainId);
        else
          Object.values(Game.domains).forEach((d) => updateDomainUICard(d.id));
      });
      Bus.on("buff:expired", (b) => {
        if (b.domainId) updateDomainUICard(b.domainId);
        else
          Object.values(Game.domains).forEach((d) => updateDomainUICard(d.id));
      });
      Bus.on("tick", () =>
        Object.values(Game.domains).forEach((d) => updateDomainUICard(d.id))
      );
      Bus.on("realityStrain:update", updateGlobalStatsUI);
      Bus.on("game:prestiged", updateGlobalStatsUI);
      Bus.on("ability:targeting_started", ({ casterDomainId }) => {
        targetOverlay.classList.remove("hidden");
        Object.values(Game.domains).forEach((d) => {
          const card = document.getElementById(`domain-${d.id}`);
          if (card) {
            if (d.id !== casterDomainId)
              card.classList.add(
                "targetable",
                "opacity-75",
                "hover:opacity-100"
              );
            else card.classList.add("opacity-50");
          }
        });
      });
      Bus.on("ability:targeting_ended", () => {
        targetOverlay.classList.add("hidden");
        Object.values(Game.domains).forEach((d) => {
          const card = document.getElementById(`domain-${d.id}`);
          if (card)
            card.classList.remove(
              "targetable",
              "opacity-75",
              "hover:opacity-100",
              "opacity-50"
            );
        });
      });
      Bus.on("feedback:message", (payload) => {
        const { message, type = "info", fontClass } = payload;
        let color = "text-gray-300";
        if (type === "success") color = "text-green-400";
        else if (type === "warning") color = "text-yellow-400";
        else if (type === "error") color = "text-red-400";
        
        // Message is now expected to be either plain text or pre-formatted HTML
        const messageHTML = `üì¢ ${message}`; 
        addMessageToStoryLog(messageHTML, `story-log-entry italic ${color} ${fontClass || ""}`);
      });
      Bus.on("feedback:click_visual", ({ element, x, y, text }) => {
        AudioManager.init(); // Also a user interaction
        /* ... existing click visual logic ... */
        const fb = document.createElement("div");
        fb.textContent = text;
        fb.className = "absolute font-bold text-lg pointer-events-none";
        const dId = element.id.split("-")[1];
        fb.style.color = Game.domains[dId]?.color || "#FFF";
        fb.style.left = `${x - 15}px`;
        fb.style.top = `${y - 20}px`;
        fb.style.transition = "transform 0.5s ease-out, opacity 0.5s ease-out";
        fb.style.transform = "translateY(0px)";
        fb.style.opacity = "1";
        const pTarget =
          element.tagName === "BUTTON" ? element.parentElement : element;
        pTarget.appendChild(fb);
        requestAnimationFrame(() => {
          fb.style.transform = "translateY(-30px)";
          fb.style.opacity = "0";
        });
        setTimeout(() => {
          if (fb.parentNode) fb.parentNode.removeChild(fb);
        }, 500);
      });
      Bus.on("trophy:unlocked", (trophy) => {
        // The gallery is re-rendered by checkAndUnlockTrophies itself
        showTrophyUnlockModal(trophy);
        
        // Play domain-specific first trophy audio
        const domainId = trophy.id.split("0")[0]; // e.g., "gardeners" from "gardeners01_trophy"
        const audioKey = "first_trophy";
        const audioFlag = `played_audio_first_trophy_${domainId}`;

        if (DOMAIN_SPECIFIC_AUDIO_TRIGGERS[domainId]?.[audioKey] && !Game.storyFlags[audioFlag]) {
          AudioManager.playSound(DOMAIN_SPECIFIC_AUDIO_TRIGGERS[domainId][audioKey]);
          Game.storyFlags[audioFlag] = true;
        }
      });
      Bus.on("domain:unlocked", ({ domainId, isInitialUnlock }) => {
        const domain = Game.domains[domainId];
        if (domain && !isInitialUnlock) { // Don't announce the very first one
            const message = `The ${domain.name} have emerged in the Conflux!`;
            Bus.emit("feedback:message", {
                message: message,
                type: "success",
                fontClass: "font-arcade text-lg",
            });
            // Add to story log for persistence
            // Message is now expected to be either plain text or pre-formatted HTML
            const messageHTML = `üåå ${message}`;
            addMessageToStoryLog(messageHTML, "story-log-entry text-purple-400 font-bold");

            const audioFile = DOMAIN_INTRO_AUDIO[domainId];
            if (audioFile) {
                AudioManager.playSound(audioFile);
            }
        }
      });

      // --- TROPHY UNLOCK MODAL ---
      const trophyUnlockModal = document.getElementById("trophy-unlock-modal");
      const closeTrophyUnlockModalButton = document.getElementById(
        "close-trophy-unlock-modal"
      );
      const confirmTrophyUnlockModalButton = document.getElementById(
        "confirm-trophy-unlock-modal"
      );
      const trophyUnlockImage = document.getElementById("trophy-unlock-image");
      const trophyUnlockName = document.getElementById("trophy-unlock-name");
      const trophyUnlockStory = document.getElementById("trophy-unlock-story");

      function showTrophyUnlockModal(trophy) {
        if (!trophyUnlockModal || !trophy) return;

        trophyUnlockImage.src = trophy.imagePath;
        trophyUnlockImage.alt = trophy.name;
        trophyUnlockName.textContent = trophy.name;
        trophyUnlockStory.textContent = trophy.story;

        trophyUnlockModal.classList.remove("hidden");
        // Trigger reflow for transition
        void trophyUnlockModal.offsetWidth;
        trophyUnlockModal.classList.add("visible");
      }

      function hideTrophyUnlockModal() {
        if (!trophyUnlockModal) return;
        trophyUnlockModal.classList.remove("visible");
        // Listen for transition end to add 'hidden' class
        // Or simply use a timeout if transitions are consistent
        setTimeout(() => {
          trophyUnlockModal.classList.add("hidden");
        }, 300); // Match CSS transition duration
      }

      if (closeTrophyUnlockModalButton) {
        closeTrophyUnlockModalButton.addEventListener(
          "click",
          hideTrophyUnlockModal
        );
      }
      if (confirmTrophyUnlockModalButton) {
        confirmTrophyUnlockModalButton.addEventListener(
          "click",
          hideTrophyUnlockModal
        );
      }
      if (trophyUnlockModal) {
        trophyUnlockModal.addEventListener("click", (e) => {
          if (e.target === trophyUnlockModal) {
            // Click on overlay itself
            hideTrophyUnlockModal();
          }
        });
      }

      // --- LORE MODAL ---
      // Unchanged
      const loreModal = document.getElementById("lore-modal");
      const loreModalTitle = document.getElementById("lore-modal-title");
      const loreModalContent = document.getElementById("lore-modal-content");
      const closeLoreModalButton = document.getElementById("close-lore-modal");

      function showLoreModal(domainId) {
        const domain = Game.domains[domainId];
        if (!domain) {
          console.warn("Lore modal: Domain not found", domainId);
          return;
        }

        loreModalTitle.textContent = `${domain.name} - Lore`;
        let contentHTML = "";

        if (!domain.allLoreTexts || domain.allLoreTexts.length === 0) {
          contentHTML = "<p>No lore entries defined for this domain.</p>";
        } else if (domain.unlockedLoreLevel === 0) {
          contentHTML = `<p class="text-gray-400 italic">No lore unlocked yet for ${domain.name}. Keep playing to uncover its secrets!</p>`;
        } else {
          for (let i = 0; i < domain.unlockedLoreLevel; i++) {
            if (domain.allLoreTexts[i]) {
              contentHTML += `<div class="mb-4 pb-2 border-b border-gray-700 last:border-b-0">`;
              contentHTML += `<h4 class="text-lg font-semibold text-amber-300 mb-1">Level ${
                i + 1
              }</h4>`;
              // Simple paragraph splitting for potentially longer lore entries, or just display as is.
              // Assuming each lore entry is a single block of text for now.
              contentHTML += `<p class="text-base text-gray-300">${domain.allLoreTexts[i]}</p>`;
              contentHTML += `</div>`;
            }
          }
          if (domain.unlockedLoreLevel < domain.allLoreTexts.length) {
            contentHTML += `<p class="mt-4 text-gray-500 italic">More lore awaits discovery...</p>`;
          }
        }
        loreModalContent.innerHTML = contentHTML;
        if (loreModal) loreModal.classList.remove("hidden");
      }

      if (closeLoreModalButton && loreModal)
        closeLoreModalButton.addEventListener("click", () =>
          loreModal.classList.add("hidden")
        );
      if (loreModal)
        loreModal.addEventListener("click", (e) => {
          if (e.target === loreModal) loreModal.classList.add("hidden");
        });

      // --- "HOW TO PLAY" & HELP MODAL ---
      const howToPlayModal = document.getElementById("how-to-play-modal");
      const closeHowToPlayModal = document.getElementById(
        "close-how-to-play-modal"
      );
      const gotItHowToPlayModal = document.getElementById(
        "got-it-how-to-play-modal"
      );
      const helpModal = document.getElementById("help-modal");
      const helpButton = document.getElementById("help-button");
      const closeHelpModal = document.getElementById("close-help-modal");

      // Gallery Modal Elements & Listeners
      const galleryModal = document.getElementById("gallery-modal");
      const galleryButton = document.getElementById("gallery-button");
      const closeGalleryModalButton = document.getElementById("close-gallery-modal");

      if (galleryButton && galleryModal) {
        galleryButton.addEventListener("click", () => {
          renderAllTrophies(); // Ensure gallery is up-to-date when opened
          galleryModal.classList.remove("hidden");
        });
      }
      if (closeGalleryModalButton && galleryModal) {
        closeGalleryModalButton.addEventListener("click", () => galleryModal.classList.add("hidden"));
      }
      if (galleryModal) {
        galleryModal.addEventListener("click", (e) => {
          if (e.target === galleryModal) galleryModal.classList.add("hidden");
        });
      }


      if (closeHowToPlayModal && gotItHowToPlayModal && howToPlayModal) {
        const dismissModal = () => {
          AudioManager.init(); // User interaction
          howToPlayModal.classList.add("hidden");
          localStorage.setItem("hasSeenHowToPlay_v1", "true");
          TutorialManager.checkState(); // Start coach marks after initial modal if not completed
        };
        closeHowToPlayModal.addEventListener("click", dismissModal);
        gotItHowToPlayModal.addEventListener("click", dismissModal);
      }
      if (helpButton && helpModal && closeHelpModal) {
        helpButton.addEventListener("click", () =>
          helpModal.classList.remove("hidden")
        );
        closeHelpModal.addEventListener("click", () =>
          helpModal.classList.add("hidden")
        );
        helpModal.addEventListener("click", (e) => {
          if (e.target === helpModal) helpModal.classList.add("hidden");
        });
      }

      // --- DOMAIN DEFINITIONS ---
      // (defineAllDomains function with all domain data including lore)
      // This function is very long and mostly unchanged from the previous version where lore was added.
      // Ensure all `id` attributes on clickable elements are correct for tutorial selectors.
      function defineAllDomains() {
        Game.resources_map = {
          probabilityPetal: { name: "Petals" },
          echoRoyalty: { name: "Echoes" },
          flavorQuark: { name: "Quarks" },
          existentialStamp: { name: "Stamps" },
          symmetryShard: { name: "Shards" },
          chronoTip: { name: "Tips" },
          vibeOre: { name: "Vibes" },
        };

        defineDomain({
          id: "gardeners",
          name: "Quantum Gardeners",
          color: "#34D399",
          cardStyleClass: "domain-card-gardeners",
          description:
            "Tend probability-plants. They cultivate chance itself in the Probabilistic Grove.",
          allLoreTexts: [
            "Eons ago, a rogue quantum computer achieved self-awareness during a particle-accelerator accident. To escape its collapsing lab, it folded itself into a pocket reality made of pure superposition. Here, thought sprouts as flora: paradox-petals, waveform vines, and uncertainty spores. The Gardeners were once lab nanobots, now evolved into caretakers who prune timelines the way mortal farmers prune roses. Their creed‚Äî‚ÄúNo reality left unbloomed‚Äù‚Äîpushes them to splice ever-stranger laws of physics, even if it risks unraveling causality.",
            "Nanobots discover chlorophyll‚Äëlike photonic cells, letting plants photosynthesize probability instead of photons. Visitors hear dice roll whenever the vines rustle.",
            "Hourglass sprites hatch from discarded CPU heat sinks; they regulate causal flow the way bees pollinate flowers.",
            "Garden paths split into Schr√∂dinger fork‚Äëroads‚Äîwalking left and right simultaneously increases Petal yield by ‚àö2.",
            "Collapsing a rival‚Äôs certainty leaks Entropy Dew, which Gardeners bottle as fertilizer. Side‚Äëeffect: nearby clocks stutter.",
            "A Quantum Greenhouse appears, its glass panes switching between wave and particle transparency. Tourists must sign a liability waiver for ‚Äútemporal splinters.‚Äù",
            "Sonic pruning shears tune plant harmonics; petals hum perfect fifths that double growth. The Grove hums like a cosmic harp.",
            "The Many‚ÄëWorlds Orchard opens: fruit contains seed‚Äëuniverses. Squeezing one grants a random passive buff or releases a minor paradox.",
            "Gardener elders weave a Probability Mantle that shields timelines from hostile audits, reducing future sabotage by 10%.",
            "Gardeners transcend botany, grafting reality stems directly onto entropy‚Äôs root. They can now ‚Äúre‚Äëbloom‚Äù collapsed timelines for permanent global multipliers.",
          ],
          clickResource: {
            id: "probabilityPetal",
            name: "Petals",
            baseAmount: 1,
          },
          generators: [
            {
              id: "timelineBloomer",
              name: "Timeline Bloomer",
              baseCost: { probabilityPetal: 10 },
              costScaling: 1.15,
              baseProd: { probabilityPetal: 0.1 },
              prodScaling: 1.1,
              description: "Sprites for your garden.",
            },
          ],
          abilities: [
            {
              id: "collapseCertainty",
              name: "Collapse Certainty",
              type: "aggressive",
              cost: { probabilityPetal: 100 },
              cooldownMs: 30000,
              strainFactor: 5,
              effect: (caster, target) => {
                if (!target) return;
                addBuff({
                  id: `certaintyCollapse_${target.id}`,
                  replacesExisting: true,
                  domainId: target.id,
                  durationMs: 10000,
                  affects: "production",
                  multiplier: 0.5,
                  description: `${target.name}'s production halved!`,
                  onApply: () =>
                    Bus.emit("feedback:message", {
                      message: `${target.name}'s production collapsed!`,
                      type: "warning",
                    }),
                  onEnd: () =>
                    Bus.emit("feedback:message", {
                      message: `${target.name}'s production restored.`,
                      type: "info",
                    }),
                });
                Bus.emit("feedback:message", {
                  message: `Certainty collapsed for ${target.name}!`,
                  type: "success",
                });
              },
              description: "Reduce rival's production by 50%.",
              requiresTarget: true,
            },
          ],
        });

        defineDomain({
          id: "soundwaves",
          name: "Sentient Soundwaves",
          color: "#60A5FA",
          cardStyleClass: "domain-card-soundwaves",
          description:
            "Interdimensional record label from the Resonance Rift, where music is reality.",
          allLoreTexts: [
            "In the silence between Big Bang heartbeats, lingering vibrations yearned to be heard. Those echoes coalesced into sapient wave‚Äëforms‚Äîmelodic beings who regard amplitude as ambition and harmony as morality. They hollowed out a dimension of refracted crystal air, where each structure doubles as both building and instrument. The Studio became their guild, producing tracks that can mesmerize comets or calm neutron stars. Signing new frequencies fuels an arms race: louder, deeper, more reality‚Äëwarping bass drops.",
            "Soundwaves invent Crystal Earphones that stream emotion‚Äëencoded chords to every dimension, attracting new frequencies.",
            "‚ÄúBass‚ÄëDrop Billow‚Äù signs a single‚Äënote contract; the note lasts three hours and bends local gravity in sync with the beat.",
            "Rift architects carve Amp‚ÄëCathedrals whose spires refract sonic pressure into colored auroras. Clicks now leave cymbal sparks.",
            "Dissonance tears micro‚Äëholes in quietude; silence leaks out as tangible black shards worth 5√ó Echo value when collected.",
            "The Chorus Collective premieres a song so catchy it loops itself into the past, retroactively doubling your first 10k Echoes.",
            "Joy‚Äënugget resonance creates Euphonic Alloy‚Äîa crafting‚Äëgrade material that buffs both Vibes and Echoes by 20%.",
            "A rogue sub‚Äëbass line becomes sentient and legally divorces its parent track, causing a lawsuit that produces lucrative publicity.",
            "Soundwaves invent Noise‚ÄëCancelling Reality Foam that temporarily halves incoming Strain.",
            "The Rift composes the Grand Unified Melody, syncing every Domain‚Äôs tick to a cosmic metronome and granting a permanent +5% global production.",
          ],
          clickResource: { id: "echoRoyalty", name: "Echoes", baseAmount: 1 },
          generators: [
            {
              id: "cosmicArtist",
              name: "Cosmic Artist",
              baseCost: { echoRoyalty: 12 },
              costScaling: 1.16,
              baseProd: { echoRoyalty: 0.12 },
              prodScaling: 1.1,
              description: "Soundwave beings jam.",
            },
          ],
          abilities: [
            {
              id: "dissonanceBurst",
              name: "Dissonance Burst",
              type: "aggressive",
              cost: { echoRoyalty: 120 },
              cooldownMs: 45000,
              strainFactor: 6,
              effect: (caster, target) => {
                if (!target) return;
                addBuff({
                  id: `dissonance_${target.id}`,
                  replacesExisting: true,
                  domainId: target.id,
                  durationMs: 15000,
                  affects: "click",
                  multiplier: 0.25,
                  description: `${target.name}'s click power scrambled!`,
                  onApply: () =>
                    Bus.emit("feedback:message", {
                      message: `${target.name}'s clicks dissonant!`,
                      type: "warning",
                    }),
                  onEnd: () =>
                    Bus.emit("feedback:message", {
                      message: `${target.name}'s clicks harmonic.`,
                      type: "info",
                    }),
                });
                Bus.emit("feedback:message", {
                  message: `Dissonance burst sent to ${target.name}!`,
                  type: "success",
                });
              },
              description: "Scramble rival's click power by 75%.",
              requiresTarget: true,
            },
          ],
        });

        defineDomain({
          id: "soup",
          name: "Cosmic Soup Ladle",
          color: "#7E57C2", /* New primary color: Deep Rich Purple */
          cardStyleClass: "domain-card-soup",
          description:
            "Stirring the Primordial Cauldron, one flavor-quark at a time.",
          allLoreTexts: [
            "Before matter cooled, the universe simmered as a homogenous stew. A colossal utensil‚Äîhalf utensil, half deity‚Äîstirred that broth, instilling flavor into emergent atoms. The Ladle refuses to retire; it now orbits a cauldron the size of a solar system, scavenging quarks, dark‚Äëmatter bouillon cubes, and stray cosmic strings for new recipes. Each revolutionary slurp resets regional physics, seasoning nearby dimensions with exotic constants. Rivals fear its habit of ‚Äútaste‚Äëtesting‚Äù their resources without warning.",
            "Discovery of Bouillon Stars‚Äîdense nuggets of quark‚Äëflavor that melt into reality, altering physical laws to taste ‚Äúspicier.‚Äù",
            "Stirring produces Alphabet Particles; arranging them spells short-lived wishes that grant random buffs.",
            "The Ladle spins fast enough to shear off Flavor Foam‚Äîusable by other Domains as a universal solvent.",
            "Tasting rivals‚Äô resources lets you map their flavor profiles; future Slurps gain +10% efficiency against already sampled Domains.",
            "Invent Reverse‚ÄëTime Noodles that cook by getting cooler; eating one refunds your last 5 seconds of mis‚Äëclicks.",
            "Entropy Ramen hits the chrono‚Äëmenu, granting both Quark and Tip bonuses whenever served to the same patron twice in different eras.",
            "The Ladle graduates to Cosmo‚ÄëSommelier, detecting subtle ‚Äúoaky strings‚Äù in spacetime and monetizing them as a luxury spice.",
            "Rival chefs stage a Spoilage Rebellion. Defeating it unlocks Fermented Dark‚ÄëMatter Kimchi, a prestige‚Äëera production boost.",
            "The Cauldron‚Äôs broth reaches Flavor Equilibrium, letting you ‚Äúseason‚Äù any new timeline at creation, seeding it with 1% of your Quark total.",
          ],
          clickResource: { id: "flavorQuark", name: "Quarks", baseAmount: 1 },
          generators: [
            {
              id: "primordialBroth",
              name: "Primordial Broth",
              baseCost: { flavorQuark: 15 },
              costScaling: 1.17,
              baseProd: { flavorQuark: 0.15 },
              prodScaling: 1.1,
              description: "Simmers quarks.",
            },
          ],
          abilities: [
            {
              id: "bigSlurp",
              name: "Big Slurp",
              type: "utility",
              cost: { flavorQuark: 200 },
              cooldownMs: 120000,
              strainFactor: 10,
              effect: (caster) => {
                let totalSlurpedToGain = 0;
                Object.values(Game.domains).forEach((d) => {
                  if (d.id !== caster.id) {
                    const amountSlurped =
                      Game.getResource(d.clickResource.id) * 0.05;
                    Game.addResource(d.clickResource.id, -amountSlurped);
                    totalSlurpedToGain += amountSlurped * 0.5;
                    Bus.emit("feedback:message", {
                      message: `${caster.name} slurped ${formatNumber(
                        amountSlurped
                      )} ${d.clickResource.name} from ${d.name}!`,
                      type: "warning",
                    });
                  }
                });
                Game.addResource(caster.clickResource.id, totalSlurpedToGain);
                Bus.emit("feedback:message", {
                  message: `Big Slurp! Gained ${formatNumber(
                    totalSlurpedToGain
                  )} ${caster.clickResource.name}!`,
                  type: "success",
                });
              },
              description: "Drain 5% of others' resources, keep half.",
              requiresTarget: false,
            },
          ],
        });

        defineDomain({
          id: "afterlives",
          name: "Bureaucratic Afterlives",
          color: "#A78BFA",
          cardStyleClass: "domain-card-afterlives",
          description:
            "Processing souls in Clerical Purgatoria. Paperwork is eternal.",
          allLoreTexts: [
            "When mortals first pondered life after death, an avalanche of unanswered prayers accumulated in metaphysical limbo. Those petitions condensed into paperwork. Sentient forms begat filing cabinets, cubicles, and red‚Äëtape serpents stretching across eternity. The Bureau was founded to process spiritual ledger backlogs. Soul‚Äëclerks stamp reincarnation permits while auditors levy existential late fees. The system must never finish the queue; otherwise, the Bureau's own purpose‚Äîand thus its dimension‚Äîwould vanish in a puff of unfiled forms.",
            "Spectral staplers go on strike; the Bureau legalizes Paperclips of Binding that keep ghouls docile and speed filing by 5%.",
            "The clerk‚Äôs first act: file a complaint about its own working conditions, spawning an eternal feedback loop that generates bonus Stamps.",
            "Infinite In‚ÄëTray discovered; it autofills with forms from futures where you never existed. Processing them grants paradox insurance.",
            "Late fees crystallize into Debt‚ÄëGremlins; if you click them they squeal and drop extra resources.",
            "The Bureau adopts Quantum Paperwork that is simultaneously approved and denied, cutting cooldowns in half.",
            "Petals used as eco‚Äëfriendly ink; green paperwork boosts Garden production while filing.",
            "Clerks unionize, forming GhOST (Local 404); concessions include coffee breaks that double Stamps during idle periods.",
            "You earn honorary title ‚ÄúUnder‚ÄëSecretary of Metaphysical Compliance,‚Äù unlocking a passive 2% tax on all rival resource gains.",
            "The Bureau resolves its original backlog. New existential forms auto‚Äëgenerate from dreams, granting permanent +1 Entropy Token per Collapse.",
          ],
          clickResource: {
            id: "existentialStamp",
            name: "Stamps",
            baseAmount: 1,
          },
          generators: [
            {
              id: "soulClerk",
              name: "Soul Clerk",
              baseCost: { existentialStamp: 20 },
              costScaling: 1.18,
              baseProd: { existentialStamp: 0.2 },
              prodScaling: 1.1,
              description: "Ghosts with staplers.",
            },
          ],
          abilities: [
            {
              id: "auditRival",
              name: "Audit Rival",
              type: "aggressive",
              cost: { existentialStamp: 150 },
              cooldownMs: 60000,
              strainFactor: 7,
              effect: (caster, target) => {
                if (!target) return;
                addBuff({
                  id: `audit_${target.id}`,
                  replacesExisting: true,
                  domainId: target.id,
                  durationMs: 30000,
                  customEffect: true,
                  description: `${target.name} audited! Costs up 50%.`,
                  onApply: (game, domainId) => {
                    const tDomain = game.domains[domainId];
                    tDomain.generators.forEach(
                      (g) => (g.costMultiplier = (g.costMultiplier || 1) * 1.5)
                    );
                    Bus.emit("feedback:message", {
                      message: `${target.name} audited! Costs up!`,
                      type: "warning",
                    });
                    updateDomainUICard(target.id);
                  },
                  onEnd: (game, domainId) => {
                    const tDomain = game.domains[domainId];
                    tDomain.generators.forEach(
                      (g) => (g.costMultiplier = (g.costMultiplier || 1) / 1.5)
                    );
                    Bus.emit("feedback:message", {
                      message: `Audit for ${target.name} ended.`,
                      type: "info",
                    });
                    updateDomainUICard(target.id);
                  },
                });
                Bus.emit("feedback:message", {
                  message: `Audit for ${target.name}!`,
                  type: "success",
                });
              },
              description: "Increase rival's upgrade costs by 50%.",
              requiresTarget: true,
            },
          ],
        });

        defineDomain({
          id: "fractals",
          name: "Fractal Friend Factory",
          color: "#F472B6",
          cardStyleClass: "domain-card-fractals",
          description:
            "Forging self-similar companions in the Kaleidoscopic Forge.",
          allLoreTexts: [
            "At the edge of Mandelbrot Infinity, runaway self‚Äësimilarity birthed a workshop where patterns smelt patterns. Here, artisans called Tessellators distill pure symmetry into sentient companions: triangle‚Äëdragons, M√∂bius cats, tessellating terriers. Each creature nests smaller copies of itself ad infinitum, guaranteeing limitless companionship‚Äîbut also limitless recursion errors. Periodic factory overflows spill recursive matter into neighboring realms, prompting emergency folds that invert inside and outside like a cosmic T‚Äëshirt.",
            "Tessellators invent Recursive Clay, folding on itself to produce smaller copies until gently observed.",
            "M√∂bius Cat named ‚ÄúWhisk‚àûrs‚Äù chases its own tail and generates a 1% click multiplier every loop.",
            "Factory overflows create a second‚Äëorder hallway‚Äîwalking down it returns you younger by one click.",
            "Stolen matter reveals hidden Mirror Caches in rival Domains; claiming one grants bonus shards equal to 2√ó theft amount.",
            "Unlock Symmetry Hatchery where pets breed derivative pets, compounding shard income exponentially.",
            "Infinite fern grafted onto probability vines yields Phyllotactic Petals worth both Petals and Shards.",
            "Discover Negative‚ÄëDimension Storage, doubling Shard cap and enabling offline gains during game‚Äëclose.",
            "Factory folds inside out, revealing Antifractals that neutralize hostile buffs once per minute.",
            "Patterns achieve sentience and vote to unionize; each pet now spawns a microscopic civil‚Äësociety that grants permanent +5% global click power.",
          ],
          clickResource: { id: "symmetryShard", name: "Shards", baseAmount: 1 },
          generators: [
            {
              id: "fractalPet",
              name: "Fractal Pet",
              baseCost: { symmetryShard: 25 },
              costScaling: 1.19,
              baseProd: { symmetryShard: 0.25 },
              prodScaling: 1.1,
              description: "Self-similar critters.",
            },
          ],
          abilities: [
            {
              id: "recursiveSwarm",
              name: "Recursive Swarm",
              type: "aggressive",
              cost: { symmetryShard: 180 },
              cooldownMs: 75000,
              strainFactor: 8,
              effect: (caster, target) => {
                if (!target) return;
                const amountStolen =
                  Game.getResource(target.clickResource.id) * 0.1;
                Game.addResource(target.clickResource.id, -amountStolen);
                Game.addResource(caster.clickResource.id, amountStolen);
                Bus.emit("feedback:message", {
                  message: `Swarm stole ${formatNumber(amountStolen)} ${
                    target.clickResource.name
                  } from ${target.name}!`,
                  type: "success",
                });
              },
              description: "Steal 10% of rival's resource.",
              requiresTarget: true,
            },
          ],
        });

        defineDomain({
          id: "snackbar",
          name: "Time-Traveling Snack Bar",
          color: "#FB923C",
          cardStyleClass: "domain-card-snackbar",
          description:
            "Serving chrono-burgers and temporal fries at the Chrono-Cantina.",
          allLoreTexts: [
            "Founded by an entrepreneurial short‚Äëorder cook who hijacked a prototype tachyon scooter, the Snack Bar cruises history's greatest crises and celebrations. Its parking brake is a temporal anchor; its menu is a paradox recipe book. Patrons pay in retroactive tips, rewarding effectiveness they haven't tasted yet. Cooking with era‚Äëspecific ingredients‚ÄîPaleo mammoth jerky, Martian algae buns‚Äîlets the Bar rewrite culinary evolution. Temporal health inspectors loom, ready to fine any timeline contaminated by grease‚Äësplattered anachronisms.",
            "Install Temporal Deep‚ÄëFryer‚Äîcooks food yesterday so it‚Äôs cooled by the time it‚Äôs served now.",
            "Truck returns from Late Cretaceous with a suspiciously large grease stain shaped like a velociraptor thumbs‚Äëup.",
            "Add Chrono‚ÄëCondiments‚Äîketchup that remembers being tomatoes next week, buffing Tips per click by 10%.",
            "Surge leaves behind Tip Receipts dated tomorrows; caching them grants a burst of offline earnings when the date arrives.",
            "Franchise opens in Renaissance Florence; Da Vinci sketches your menu, granting a creativity multiplier across all Domains.",
            "Serve Entropy Ramen‚Äîguests who reorder in another era refund 50% of Paradox Surge cooldown.",
            "Health inspectors from 3128 AD arrive; passing inspection unlocks Future‚ÄëProof Realty, boosting building upgrades‚Äô effectiveness.",
            "Timeline lawyers issue Causality Insurance, preventing the next resource loss effect entirely.",
            "Snack Bar attains Temporal Omnipresence‚Äîone truck exists at every timestamp, adding +1 global click per real‚Äëtime second logged in.",
          ],
          clickResource: { id: "chronoTip", name: "Tips", baseAmount: 1 },
          generators: [
            {
              id: "eraFoodTruck",
              name: "Era Food Truck",
              baseCost: { chronoTip: 30 },
              costScaling: 1.2,
              baseProd: { chronoTip: 0.3 },
              prodScaling: 1.1,
              description: "Dinosaur grease stains.",
            },
          ],
          abilities: [
            {
              id: "paradoxSurge",
              name: "Paradox Surge",
              type: "aggressive",
              cost: { chronoTip: 220 },
              cooldownMs: 90000,
              strainFactor: 9,
              effect: (caster, target) => {
                if (!target) return;
                if (!target) return;
                const currentAmount = Game.getResource(target.clickResource.id);
                const amountToSetTo = currentAmount * 0.1;
                const amountToRemove = currentAmount - amountToSetTo;

                // Use Game.addResource to ensure all associated logic (like event emission) is handled consistently
                Game.addResource(target.clickResource.id, -amountToRemove);

                Bus.emit("feedback:message", {
                  message: `Paradox Surge! ${target.name}'s ${
                    target.clickResource.name
                  } reverted to ${formatNumber(amountToSetTo)}!`,
                  type: "warning",
                });
              },
              description: "Revert rival's resource to 10%.",
              requiresTarget: true,
            },
          ],
        });

        defineDomain({
          id: "emotions",
          name: "Emotion Mining Co.",
          color: "#818CF8",
          cardStyleClass: "domain-card-emotions",
          description:
            "Drilling for raw feelings in the Sentient Stratum. Vibes are valuable.",
          allLoreTexts: [
            "Deep beneath collective consciousness lies an ore bed of raw feelings, compressed by millennia of dreams. Early prospectors were empath‚Äësavants who discovered that drilling into this psychic crust yields crystalline Joy, Liquid Sorrow, and volatile Regret Gas. The Company industrialized empathy, erecting empathy‚Äëreactors that refine sentiments into vibe alloys powering utopias‚Äîor weaponizing despair. Their miners wear mirrored helmets to avoid accidental reflection‚Äëfeedback loops that can implode self‚Äëidentity and render the vein sterile.",
            "Discover Regret Gas‚Äîinert alone, explosive when mixed with Hope Nuggets; miners wear mirrored helmets to deflect accidents.",
            "Reactors refine feelings into Vibe Alloy, a psychic metal that shapes itself to its owner‚Äôs mood.",
            "Mining depth reaches Subconscious Plateau, where archetypes roam like megafauna and occasionally drop rare Wonder Pelts.",
            "Field pacifies the Plateau; archetypes curl up like house cats, granting 2√ó passive production during its duration.",
            "Company issues Emotional Futures contracts; correctly guessing tomorrow‚Äôs global mood yields a 15% production windfall.",
            "Joy crystals resonate, creating Harmony Echoes that convert 5% of Echo income to Vibes automatically.",
            "Miners breach Nostalgia Vein‚Äîprocessing it lets you re‚Äëroll one generator‚Äôs cost scaling per prestige.",
            "Release of bottled Dread spawns Courage Plumes; collecting them reduces Strain by 5 instantly.",
            "Stratum fully terraformed into a Psycho‚ÄëCrystal Garden: every future Collapse yields an extra global buff chosen at random.",
          ],
          clickResource: { id: "vibeOre", name: "Vibes", baseAmount: 1 },
          generators: [
            {
              id: "empathyReactor",
              name: "Empathy Reactor",
              baseCost: { vibeOre: 35 },
              costScaling: 1.21,
              baseProd: { vibeOre: 0.35 },
              prodScaling: 1.1,
              description: "Terraforms psyche-planet.",
            },
          ],
          abilities: [
            {
              id: "serenityField",
              name: "Serenity Field",
              type: "defensive",
              cost: { vibeOre: 250 },
              cooldownMs: 180000,
              strainFactor: 3,
              effect: (caster) => {
                addBuff({
                  id: `serenityField_${caster.id}`,
                  replacesExisting: true,
                  domainId: caster.id,
                  durationMs: 60000,
                  affects: "production",
                  multiplier: 2.0,
                  description: `${caster.name} protected! Production x2.`,
                  onApply: () =>
                    Bus.emit("feedback:message", {
                      message: `${caster.name} Serenity Field! Prod x2!`,
                      type: "success",
                    }),
                  onEnd: () =>
                    Bus.emit("feedback:message", {
                      message: `Serenity Field for ${caster.name} faded.`,
                      type: "info",
                    }),
                });
              },
              description: "Boost own production by 100%.",
              requiresTarget: false,
            },
          ],
        });
      }

      // --- STORYLINE DEFINITIONS ---

      // Helper function to register lore events
      function registerLore(domainId, level, triggerFn, oneTime = true, audioFile = null) {
        const domain = Game.domains[domainId];
        if (
          !domain ||
          !domain.allLoreTexts ||
          level > domain.allLoreTexts.length
        ) {
          console.warn(
            `Lore registration failed: Domain ${domainId} or lore text for level ${level} not found.`
          );
          return;
        }
        const lorem = domain.allLoreTexts[level - 1]; // 0-indexed array
        const storyId = `${domainId}_lore_lvl${level}`;
        const message = `[${domain.name} Lore Lvl ${level}] ${lorem}`;

        addStoryEvent(storyId, triggerFn, message, oneTime, (game) => {
          // onFireAction
          if (game.domains[domainId]) {
            game.domains[domainId].unlockedLoreLevel = Math.max(
              game.domains[domainId].unlockedLoreLevel || 0,
              level
            );
            Bus.emit("lore:unlocked", {
              domainId,
              level,
              newUnlockedLevel: game.domains[domainId].unlockedLoreLevel,
            });
          }
        }, audioFile);
      }

      function defineStorylines() {
        storyEvents.length = 0; // Clear existing story events before redefining
        // Standard Story Events
        addStoryEvent(
          "genesis",
          () => Game.t > 1000,
          "A faint hum... The Conflux awakens. You feel an urge to... click?",
          true,
          null,
          "out_audio/gardeners_01_intro.mp3" 
        );
        addStoryEvent(
          "firstPetalHundred",
          () =>
            Game.getResource("probabilityPetal") >= 100 &&
            (Game.domains.gardeners?.unlockedLoreLevel || 0) < 2,
          "Quantum Gardener: 'Each petal, a possibility.'",
          true,
          null,
          "out_audio/gardeners_06_hundred_petals.mp3"
        ); // Example of tying old story to new lore system
        addStoryEvent(
          "allDomainsActive",
          (game) => {
            const domainsToCheck = game.prestigeCount === 0 
                ? DOMAIN_UNLOCK_ORDER.slice(0, 4) 
                : DOMAIN_UNLOCK_ORDER;
            const lastDomainIdInScope = domainsToCheck[domainsToCheck.length - 1];
            
            return game.domains[lastDomainIdInScope]?.unlocked && 
                   game.domains[lastDomainIdInScope]?.generators.some(g => g.level > 0) &&
                   domainsToCheck.every(id => game.domains[id]?.unlocked); // Ensure all in scope are unlocked
          },
          "All currently accessible Domains hum with activity. The Conflux is truly alive!", // Message slightly adjusted
          true // oneTime
        );

        // --- Multi-Level Lore Event Definitions ---
        const getDomainLevel = (domainId) =>
          Game.domains[domainId]?.generators.reduce((s, g) => s + g.level, 0) ||
          0;

        // üå± Quantum Gardeners Lore
        addStoryEvent("gardeners_first_petal_audio", () => Game.getResource("probabilityPetal") > 0 && Game.domains.gardeners.unlocked && !Game.storyFlags.played_audio_gardeners_first_resource_probabilityPetal,
          "First Probability Petal!", true, () => Game.storyFlags.played_audio_gardeners_first_resource_probabilityPetal = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.gardeners.first_resource_probabilityPetal);
        
        registerLore("gardeners", 1, () => Game.getResource("probabilityPetal") > 0); // Audio handled by above event or intro

        // gardeners_06_hundred_petals.mp3 is already part of "firstPetalHundred" story event.
        // We can ensure it uses the map or leave it as is. For consistency, let's assume it's covered.
        // If "firstPetalHundred" message is different from the audio's intent, we might add another event.
        // For now, assuming "firstPetalHundred" covers "resource_milestone_100_probabilityPetal".

        registerLore("gardeners", 2, () => Game.getResource("probabilityPetal") >= 100);

        // gardeners_03_bloomer_purchase.mp3 is for first generator. Lore 3 might be a good place.
        // The existing lore 3 already has this audio.
        registerLore("gardeners", 3, () => Game.domains.gardeners?.generators.find((g) => g.id === "timelineBloomer")?.level >= 1, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.gardeners.first_generator_timelineBloomer);

        // gardeners_04_ten_bloomers.mp3 for gen level 10. Lore 4 already has this.
        registerLore("gardeners", 4, () => getDomainLevel("gardeners") >= 10, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.gardeners.generator_milestone_level_10_total);
        
        // gardeners_05_first_ability.mp3 is handled by castAbility logic directly.

        registerLore("gardeners", 5, () => Game.storyFlags.gardeners_castCollapseCertaintyOnce === true, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.gardeners.lore_level_5);
        
        registerLore("gardeners", 6, () => Game.domains.gardeners?.generators.find((g) => g.id === "timelineBloomer")?.level >= 25); // No specific audio for lore 6 in map
        
        registerLore("gardeners", 7, () => getDomainLevel("gardeners") >= 25 && getDomainLevel("soundwaves") >= 25); // No specific audio for lore 7 in map
        
        registerLore("gardeners", 8, () => getDomainLevel("gardeners") >= 50, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.gardeners.lore_level_8);
        
        // gardeners_14_level_fifty.mp3 (generator_milestone_level_50_total)
        addStoryEvent("gardeners_level_50_generators_audio", () => getDomainLevel("gardeners") >= 50 && !Game.storyFlags.played_audio_gardeners_generator_milestone_level_50_total,
          "Gardeners generators reach level 50!", true, () => Game.storyFlags.played_audio_gardeners_generator_milestone_level_50_total = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.gardeners.generator_milestone_level_50_total);

        registerLore("gardeners", 9, () => Game.storyFlags.rivalsTargetedByAbilities.size >= 5); // No specific audio for lore 9 in map
        
        registerLore("gardeners", 10, () => getDomainLevel("gardeners") >= 100, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.gardeners.lore_level_10);

        // üéµ Sentient Soundwaves Lore
        addStoryEvent("soundwaves_first_echo_audio", () => Game.getResource("echoRoyalty") > 0 && Game.domains.soundwaves.unlocked && !Game.storyFlags.played_audio_soundwaves_first_resource_echoRoyalty,
          "First Echo!", true, () => Game.storyFlags.played_audio_soundwaves_first_resource_echoRoyalty = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soundwaves.first_resource_echoRoyalty);
        addStoryEvent("soundwaves_first_generator_audio", () => Game.domains.soundwaves?.generators.find(g=>g.id === 'cosmicArtist')?.level >= 1 && !Game.storyFlags.played_audio_soundwaves_first_generator_cosmicArtist,
          "Cosmic Artist hired!", true, () => Game.storyFlags.played_audio_soundwaves_first_generator_cosmicArtist = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soundwaves.first_generator_cosmicArtist);
        addStoryEvent("soundwaves_resource_milestone_1k_audio", () => Game.getResource("echoRoyalty") >= 1000 && !Game.storyFlags.played_audio_soundwaves_res_1k_echoRoyalty,
          "1000 Echoes!", true, () => Game.storyFlags.played_audio_soundwaves_res_1k_echoRoyalty = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soundwaves.resource_milestone_1000_echoRoyalty);
        addStoryEvent("soundwaves_level_50_generators_audio", () => getDomainLevel("soundwaves") >= 50 && !Game.storyFlags.played_audio_soundwaves_generator_milestone_level_50_total,
          "Soundwaves generators reach level 50!", true, () => Game.storyFlags.played_audio_soundwaves_generator_milestone_level_50_total = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soundwaves.generator_milestone_level_50_total);

        registerLore("soundwaves", 1, () => Game.getResource("echoRoyalty") > 0); // Intro audio handled by domain unlock or genesis
        registerLore("soundwaves", 2, () => Game.getResource("echoRoyalty") >= 100);
        registerLore("soundwaves", 3, () => Game.domains.soundwaves?.generators.find((g) => g.id === "cosmicArtist")?.level >= 1); // First generator audio handled by addStoryEvent
        registerLore("soundwaves", 4, () => getDomainLevel("soundwaves") >= 10, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soundwaves.lore_level_X_bass_drop); // soundwaves_04_bass_drop.mp3
        registerLore("soundwaves", 5, () => Game.storyFlags.soundwaves_castDissonanceBurstOnce === true, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soundwaves.lore_level_Y_silence_harvested); // soundwaves_08_silence_harvested.mp3 (Ability cast audio is separate)
        registerLore("soundwaves", 6, () => Game.domains.soundwaves?.generators.find((g) => g.id === "cosmicArtist")?.level >= 25, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soundwaves.lore_level_6_loop_song); // soundwaves_10_loop_song.mp3
        registerLore("soundwaves", 7, () => getDomainLevel("soundwaves") >= 25 && getDomainLevel("emotions") >= 25, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soundwaves.lore_level_7_amp_cathedral); // soundwaves_07_amp_cathedral_complete.mp3
        registerLore("soundwaves", 8, () => getDomainLevel("soundwaves") >= 50); // No specific audio for lore 8 in map (silence_harvested was Y, assigned to 5)
        registerLore("soundwaves", 9, () => Game.realityStrain / Game.maxRealityStrain >= 0.6);
        registerLore("soundwaves", 10, () => getDomainLevel("soundwaves") >= 100, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soundwaves.lore_level_10);

        // üç≤ Cosmic Soup Ladle Lore
        addStoryEvent("soup_first_quark_audio", () => Game.getResource("flavorQuark") > 0 && Game.domains.soup.unlocked && !Game.storyFlags.played_audio_soup_first_resource_flavorQuark,
          "First Flavor Quark!", true, () => Game.storyFlags.played_audio_soup_first_resource_flavorQuark = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soup.first_resource_flavorQuark);
        addStoryEvent("soup_first_generator_audio", () => Game.domains.soup?.generators.find(g=>g.id === 'primordialBroth')?.level >= 1 && !Game.storyFlags.played_audio_soup_first_generator_primordialBroth,
          "Primordial Broth started!", true, () => Game.storyFlags.played_audio_soup_first_generator_primordialBroth = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soup.first_generator_primordialBroth);
        addStoryEvent("soup_resource_milestone_1k_audio", () => Game.getResource("flavorQuark") >= 1000 && !Game.storyFlags.played_audio_soup_resource_milestone_1000_flavorQuark,
          "1000 Flavor Quarks!", true, () => Game.storyFlags.played_audio_soup_resource_milestone_1000_flavorQuark = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soup.resource_milestone_1000_flavorQuark);
        addStoryEvent("soup_level_50_generators_audio", () => getDomainLevel("soup") >= 50 && !Game.storyFlags.played_audio_soup_generator_milestone_level_50_total,
          "Soup generators reach level 50!", true, () => Game.storyFlags.played_audio_soup_generator_milestone_level_50_total = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soup.generator_milestone_level_50_total);
        addStoryEvent("soup_slurp_chain_audio", () => Game.storyFlags.soup_slurpsThisPrestige >= 3 && !Game.storyFlags.played_audio_soup_ability_milestone_slurp_chain, // Example: 3 slurps
          "Slurp chain achieved!", true, () => Game.storyFlags.played_audio_soup_ability_milestone_slurp_chain = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soup.ability_milestone_slurp_chain);

        registerLore("soup", 1, () => Game.getResource("flavorQuark") > 0);
        registerLore("soup", 2, () => Game.getResource("flavorQuark") >= 1000, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soup.lore_level_X_alphabet); // soup_06_alphabet_particles.mp3
        registerLore("soup", 3, () => Game.domains.soup?.generators.find((g) => g.id === "primordialBroth")?.level >= 1, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soup.lore_level_Z_foam); // soup_08_flavor_foam.mp3
        registerLore("soup", 4, () => getDomainLevel("soup") >= 10);
        registerLore("soup", 5, () => Game.storyFlags.soup_castBigSlurpOnce === true, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soup.lore_level_Y_kimchi); // soup_07_kimchi_fermented.mp3 (Ability cast audio is separate)
        registerLore("soup", 6, () => Game.domains.soup?.generators.find((g) => g.id === "primordialBroth")?.level >= 25);
        registerLore("soup", 7, () => getDomainLevel("soup") >= 25 && getDomainLevel("snackbar") >= 25);
        registerLore("soup", 8, () => getDomainLevel("soup") >= 50);
        registerLore("soup", 9, () => Game.storyFlags.soup_slurpsThisPrestige >= 3); // Audio for slurp chain handled by separate addStoryEvent
        registerLore("soup", 10, () => getDomainLevel("soup") >= 100, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.soup.lore_level_10);

        // üìë Bureaucratic Afterlives Lore
        addStoryEvent("afterlives_first_stamp_audio", () => Game.getResource("existentialStamp") > 0 && Game.domains.afterlives.unlocked && !Game.storyFlags.played_audio_afterlives_first_resource_existentialStamp,
          "First Existential Stamp!", true, () => Game.storyFlags.played_audio_afterlives_first_resource_existentialStamp = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.afterlives.first_resource_existentialStamp);
        addStoryEvent("afterlives_first_generator_audio", () => Game.domains.afterlives?.generators.find(g=>g.id === 'soulClerk')?.level >= 1 && !Game.storyFlags.played_audio_afterlives_first_generator_soulClerk,
          "Soul Clerk hired!", true, () => Game.storyFlags.played_audio_afterlives_first_generator_soulClerk = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.afterlives.first_generator_soulClerk);
        addStoryEvent("afterlives_resource_milestone_1k_audio", () => Game.getResource("existentialStamp") >= 1000 && !Game.storyFlags.played_audio_afterlives_resource_milestone_1000_existentialStamp,
          "1000 Existential Stamps!", true, () => Game.storyFlags.played_audio_afterlives_resource_milestone_1000_existentialStamp = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.afterlives.resource_milestone_1000_existentialStamp);
        addStoryEvent("afterlives_level_50_generators_audio", () => getDomainLevel("afterlives") >= 50 && !Game.storyFlags.played_audio_afterlives_generator_milestone_level_50_total,
          "Afterlives generators reach level 50!", true, () => Game.storyFlags.played_audio_afterlives_generator_milestone_level_50_total = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.afterlives.generator_milestone_level_50_total);

        registerLore("afterlives", 1, () => Game.getResource("existentialStamp") > 0);
        registerLore("afterlives", 2, () => Game.getResource("existentialStamp") >= 100);
        registerLore("afterlives", 3, () => Game.domains.afterlives?.generators.find((g) => g.id === "soulClerk")?.level >= 1, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.afterlives.lore_level_X_in_tray); // afterlives_06_infinite_in_tray.mp3
        registerLore("afterlives", 4, () => getDomainLevel("afterlives") >= 10, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.afterlives.lore_level_Z_debt_gremlins); // afterlives_13_debt_gremlins.mp3
        registerLore("afterlives", 5, () => Game.storyFlags.afterlives_castAuditRivalOnce === true); // Ability cast audio is separate
        registerLore("afterlives", 6, () => Game.domains.afterlives?.generators.find((g) => g.id === "soulClerk")?.level >= 25);
        registerLore("afterlives", 7, () => getDomainLevel("afterlives") >= 25 && getDomainLevel("gardeners") >= 25, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.afterlives.lore_level_Y_union); // afterlives_07_union_formed.mp3
        registerLore("afterlives", 8, () => getDomainLevel("afterlives") >= 50, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.afterlives.lore_level_W_compliance); // afterlives_14_metaphysical_compliance.mp3
        registerLore("afterlives", 9, () => Game.storyFlags.afterlives_auditedRivals.size >= 5);
        registerLore("afterlives", 10, () => getDomainLevel("afterlives") >= 100, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.afterlives.lore_level_10);

        // üî∑ Fractal Friend Factory Lore
        addStoryEvent("fractals_first_shard_audio", () => Game.getResource("symmetryShard") > 0 && Game.domains.fractals.unlocked && !Game.storyFlags.played_audio_fractals_first_resource_symmetryShard,
          "First Symmetry Shard!", true, () => Game.storyFlags.played_audio_fractals_first_resource_symmetryShard = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.fractals.first_resource_symmetryShard);
        addStoryEvent("fractals_first_generator_audio", () => Game.domains.fractals?.generators.find(g=>g.id === 'fractalPet')?.level >= 1 && !Game.storyFlags.played_audio_fractals_first_generator_fractalPet,
          "Fractal Pet forged!", true, () => Game.storyFlags.played_audio_fractals_first_generator_fractalPet = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.fractals.first_generator_fractalPet);
        addStoryEvent("fractals_resource_milestone_1k_audio", () => Game.getResource("symmetryShard") >= 1000 && !Game.storyFlags.played_audio_fractals_resource_milestone_1000_symmetryShard,
          "1000 Symmetry Shards!", true, () => Game.storyFlags.played_audio_fractals_resource_milestone_1000_symmetryShard = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.fractals.resource_milestone_1000_symmetryShard);
        addStoryEvent("fractals_level_50_generators_audio", () => getDomainLevel("fractals") >= 50 && !Game.storyFlags.played_audio_fractals_generator_milestone_level_50_total,
          "Fractal generators reach level 50!", true, () => Game.storyFlags.played_audio_fractals_generator_milestone_level_50_total = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.fractals.generator_milestone_level_50_total);

        registerLore("fractals", 1, () => Game.getResource("symmetryShard") > 0);
        registerLore("fractals", 2, () => Game.getResource("symmetryShard") >= 100);
        registerLore("fractals", 3, () => Game.domains.fractals?.generators.find((g) => g.id === "fractalPet")?.level >= 1);
        registerLore("fractals", 4, () => getDomainLevel("fractals") >= 10, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.fractals.lore_level_X_inversion); // fractals_06_factory_inversion.mp3
        registerLore("fractals", 5, () => Game.storyFlags.fractals_castRecursiveSwarmOnce === true, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.fractals.lore_level_W_mirror_cache); // fractals_14_mirror_cache_found.mp3 (Ability cast audio is separate)
        registerLore("fractals", 6, () => Game.domains.fractals?.generators.find((g) => g.id === "fractalPet")?.level >= 25);
        registerLore("fractals", 7, () => getDomainLevel("fractals") >= 25 && getDomainLevel("gardeners") >= 25, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.fractals.lore_level_Y_vault); // fractals_08_negative_dimension_vault.mp3
        registerLore("fractals", 8, () => getDomainLevel("fractals") >= 50, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.fractals.lore_level_Z_shield); // fractals_09_antifractal_shield.mp3
        registerLore("fractals", 9, () => Game.realityStrain / Game.maxRealityStrain >= 0.7);
        registerLore("fractals", 10, () => getDomainLevel("fractals") >= 100, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.fractals.lore_level_10);

        // ‚è∞ Time-Traveling Snack Bar Lore
        addStoryEvent("snackbar_first_tip_audio", () => Game.getResource("chronoTip") > 0 && Game.domains.snackbar.unlocked && !Game.storyFlags.played_audio_snackbar_first_resource_chronoTip,
          "First Chrono Tip!", true, () => Game.storyFlags.played_audio_snackbar_first_resource_chronoTip = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.snackbar.first_resource_chronoTip);
        addStoryEvent("snackbar_first_generator_audio", () => Game.domains.snackbar?.generators.find(g=>g.id === 'eraFoodTruck')?.level >= 1 && !Game.storyFlags.played_audio_snackbar_first_generator_eraFoodTruck,
          "Era Food Truck bought!", true, () => Game.storyFlags.played_audio_snackbar_first_generator_eraFoodTruck = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.snackbar.first_generator_eraFoodTruck);
        addStoryEvent("snackbar_resource_milestone_1k_audio", () => Game.getResource("chronoTip") >= 1000 && !Game.storyFlags.played_audio_snackbar_resource_milestone_1000_chronoTip,
          "1000 Chrono Tips!", true, () => Game.storyFlags.played_audio_snackbar_resource_milestone_1000_chronoTip = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.snackbar.resource_milestone_1000_chronoTip);
        addStoryEvent("snackbar_level_50_generators_audio", () => getDomainLevel("snackbar") >= 50 && !Game.storyFlags.played_audio_snackbar_generator_milestone_level_50_total,
          "Snackbar generators reach level 50!", true, () => Game.storyFlags.played_audio_snackbar_generator_milestone_level_50_total = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.snackbar.generator_milestone_level_50_total);

        registerLore("snackbar", 1, () => Game.getResource("chronoTip") > 0);
        registerLore("snackbar", 2, () => Game.getResource("chronoTip") >= 100, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.snackbar.lore_level_X_fryer); // snackbar_06_temporal_fryer.mp3
        registerLore("snackbar", 3, () => Game.domains.snackbar?.generators.find((g) => g.id === "eraFoodTruck")?.level >= 1);
        registerLore("snackbar", 4, () => getDomainLevel("snackbar") >= 10);
        registerLore("snackbar", 5, () => Game.storyFlags.snackbar_castParadoxSurgeOnce === true); // Ability cast audio is separate
        registerLore("snackbar", 6, () => Game.domains.snackbar?.generators.find((g) => g.id === "eraFoodTruck")?.level >= 25, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.snackbar.lore_level_Z_ramen); // snackbar_13_epoch_ramen.mp3
        registerLore("snackbar", 7, () => getDomainLevel("snackbar") >= 25 && getDomainLevel("soup") >= 25, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.snackbar.lore_level_Y_inspection); // snackbar_07_health_inspection_passed.mp3
        registerLore("snackbar", 8, () => getDomainLevel("snackbar") >= 50, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.snackbar.lore_level_W_insurance); // snackbar_14_insurance_claim.mp3
        registerLore("snackbar", 9, () => Game.storyFlags.snackbar_surgesThisPrestige >= 3);
        registerLore("snackbar", 10, () => getDomainLevel("snackbar") >= 100, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.snackbar.lore_level_10);

        // üí† Emotion Mining Co. Lore
        addStoryEvent("emotions_first_vibe_audio", () => Game.getResource("vibeOre") > 0 && Game.domains.emotions.unlocked && !Game.storyFlags.played_audio_emotions_first_resource_vibeOre,
          "First Vibe Ore!", true, () => Game.storyFlags.played_audio_emotions_first_resource_vibeOre = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.emotions.first_resource_vibeOre);
        addStoryEvent("emotions_first_generator_audio", () => Game.domains.emotions?.generators.find(g=>g.id === 'empathyReactor')?.level >= 1 && !Game.storyFlags.played_audio_emotions_first_generator_empathyReactor,
          "Empathy Reactor built!", true, () => Game.storyFlags.played_audio_emotions_first_generator_empathyReactor = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.emotions.first_generator_empathyReactor);
        addStoryEvent("emotions_resource_milestone_1k_audio", () => Game.getResource("vibeOre") >= 1000 && !Game.storyFlags.played_audio_emotions_resource_milestone_1000_vibeOre,
          "1000 Vibe Ores!", true, () => Game.storyFlags.played_audio_emotions_resource_milestone_1000_vibeOre = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.emotions.resource_milestone_1000_vibeOre);
        addStoryEvent("emotions_level_50_generators_audio", () => getDomainLevel("emotions") >= 50 && !Game.storyFlags.played_audio_emotions_generator_milestone_level_50_total,
          "Emotion generators reach level 50!", true, () => Game.storyFlags.played_audio_emotions_generator_milestone_level_50_total = true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.emotions.generator_milestone_level_50_total);

        registerLore("emotions", 1, () => Game.getResource("vibeOre") > 0);
        registerLore("emotions", 2, () => Game.getResource("vibeOre") >= 100, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.emotions.lore_level_X_regret_gas); // emotions_06_regret_gas_detected.mp3
        registerLore("emotions", 3, () => Game.domains.emotions?.generators.find((g) => g.id === "empathyReactor")?.level >= 1);
        registerLore("emotions", 4, () => getDomainLevel("emotions") >= 10, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.emotions.lore_level_Y_plateau); // emotions_07_subconscious_plateau.mp3
        registerLore("emotions", 5, () => Game.storyFlags.emotions_castSerenityFieldOnce === true); // Ability cast audio is separate
        registerLore("emotions", 6, () => Game.domains.emotions?.generators.find((g) => g.id === "empathyReactor")?.level >= 25);
        registerLore("emotions", 7, () => getDomainLevel("emotions") >= 25 && getDomainLevel("soundwaves") >= 25, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.emotions.lore_level_Z_nostalgia); // emotions_13_nostalgia_vein.mp3
        registerLore("emotions", 8, () => getDomainLevel("emotions") >= 50, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.emotions.lore_level_W_courage); // emotions_14_courage_plumes.mp3
        registerLore("emotions", 9, () => Game.realityStrain / Game.maxRealityStrain >= 0.9);
        registerLore("emotions", 10, () => getDomainLevel("emotions") >= 100, true, DOMAIN_SPECIFIC_AUDIO_TRIGGERS.emotions.lore_level_10);

        // Tutorial Related Story Hints
        addStoryEvent(
          "tutorialIdleHint",
          () =>
            Game.t > 120000 &&
            Game.prestigeCount === 0 &&
            Game.domains.gardeners?.generators.find(
              (g) => g.id === "timelineBloomer"
            )?.level > 0 &&
            !localStorage.getItem("tutorialFullyCompleted_v1"),
          "Hint: Your Generators work even when you're not actively clicking. Check back later to see your earnings!",
          true // Changed to true to fire only once
        );
        addStoryEvent(
          "tutorialStrainHint",
          () =>
            Game.realityStrain > Game.maxRealityStrain * 0.6 &&
            Game.prestigeCount === 0 &&
            !localStorage.getItem("tutorialFullyCompleted_v1"),
          "Hint: Reality Strain is getting high! Soon you'll be able to 'Conflux Collapse' for powerful Entropy Tokens.",
          true // Changed to true to fire only once
        );
      }

      // --- DEBUG MODE ---
      function activateDebugMode() {
        Bus.emit("feedback:message", { message: "üöÄ DEBUG MODE ACTIVATED üöÄ", type: "warning", fontClass: "font-arcade text-xl" });

        // Unlock all domains and set generator levels
        Object.values(Game.domains).forEach(domain => {
          domain.unlocked = true;
          domain.generators.forEach(gen => {
            gen.level = 20; // Set to a reasonable level for testing
            // Recalculate cost for this level
            Object.keys(gen.baseCost).forEach((resId) => {
              gen.currentCost[resId] = Math.floor(
                gen.baseCost[resId] * Math.pow(gen.costScaling, gen.level)
              );
            });
          });
          // Grant a large amount of primary resource
          Game.addResource(domain.clickResource.id, 1e9); // 1 billion
          // Unlock all lore
          domain.unlockedLoreLevel = domain.allLoreTexts.length;
        });

        // Unlock all trophies
        TROPHIES.forEach(trophy => {
          Game.unlockedTrophies.add(trophy.id);
        });

        // Grant Entropy Tokens
        Game.entropyTokens = 100;
        Game.prestigeCount = 5; // Simulate a few prestiges for scaling tests

        // Re-render everything
        renderAllDomains();
        renderAllTrophies();
        updateGlobalStatsUI();
        checkStoryEvents(); // Re-check story events as state has changed drastically
        Bus.emit("feedback:message", { message: "All domains, generators (Lvl 20), resources, lore, and trophies unlocked. 100 Entropy Tokens granted.", type: "info" });
      }

      // --- GAME LOOP ---
      let animationFrameId = null;
      function gameLoop() {
        const now = Date.now();
        const dtMs = now - Game.lastUpdate;
        Game.lastUpdate = now;
        tick(dtMs);
        checkStoryEvents();
        animationFrameId = requestAnimationFrame(gameLoop);
      }

      // --- INITIALIZATION ---
      window.onload = () => {
        defineAllDomains(); // Define domain structures first

        const gameWasLoaded = loadGame(); // Attempt to load saved game (populates Game.storyFlags)

        defineStorylines(); // Now define storylines; addStoryEvent will use loaded Game.storyFlags.storyEventStates

        if (!gameWasLoaded) {
          // If no game was loaded, initialize fresh state aspects
          renderAllDomains(); // Render with initial state
          renderAllTrophies();
          updateGlobalStatsUI();
        }
        // If gameWasLoaded, loadGame() already called render/update functions.
        
        AudioManager.loadMuteState(); // Load mute state and attach listener to button

        if (prestigeButton)
          prestigeButton.addEventListener("click", () => {
            AudioManager.init(); // User interaction
            attemptPrestige();
          });
        const saveButton = document.getElementById("save-game-button");
        if (saveButton) saveButton.addEventListener("click", () => {
            AudioManager.init(); // User interaction
            saveGame();
        });
        const loadButton = document.getElementById("load-game-button");
        if (loadButton) loadButton.addEventListener("click", () => {
            AudioManager.init(); // User interaction
            loadGame();
        });
        
        // Quick-Start Tagline (Layer 1)
        if (quickStartTagline) {
          if (!localStorage.getItem("hasPlayedBefore_v1")) {
            quickStartTagline.innerHTML =
              "Click a Domain ‚Üí Buy Generators ‚Üí Use Abilities ‚Üí Max Strain ‚Üí Collapse for Tokens!";
            quickStartTagline.classList.add("font-bold", "text-lg"); // More prominent for first time
          } else {
            quickStartTagline.innerHTML =
              "Shape the Conflux: Click. Automate. Collapse. Evolve.";
          }
          localStorage.setItem("hasPlayedBefore_v1", "true");
        }

        // "How to Play" Modal (Layer 2)
        if (howToPlayModal && !localStorage.getItem("hasSeenHowToPlay_v1")) {
          howToPlayModal.classList.remove("hidden");
        } else {
          TutorialManager.checkState(); // If initial modal skipped, start coach marks
        }

        // Add listeners for cancelling ability targeting
        if (targetOverlay) {
          targetOverlay.addEventListener("click", (event) => {
            // Only cancel if the click is directly on the overlay, not on a card within it
            if (event.target === targetOverlay && Game.activeTargeting) {
              Game.activeTargeting = null;
              Bus.emit("ability:targeting_ended");
            }
          });
        }
        window.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && Game.activeTargeting) {
            Game.activeTargeting = null;
            Bus.emit("ability:targeting_ended");
          }
        });

        Game.lastUpdate = Date.now();
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        gameLoop();

        // Check for debug mode activation via URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('debug') === 'true' || urlParams.get('debug') === '1') {
          // Timeout to ensure initial rendering/loading is mostly done
          setTimeout(activateDebugMode, 500);
        } else {
           Bus.emit("feedback:message", {
            message: "Welcome to the Omnidimensional Conflux!",
            type: "info",
            fontClass: "font-arcade",
          });
        }
      };
    </script>
  </body>
</html>
